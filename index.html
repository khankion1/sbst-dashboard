<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SBST √ó NVIDIA cuOPT ‚Äî Network Command Centre</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f4f6fa;--surface:#fff;--surface2:#f0f3f8;--border:#dde3ef;
  --accent:#0066cc;--accent-light:#e8f0fb;
  --accent2:#16a34a;--accent2-light:#dcfce7;
  --warning:#d97706;--warning-light:#fef3c7;
  --danger:#dc2626;--danger-light:#fee2e2;
  --text:#0f172a;--text2:#374151;--muted:#6b7280;
  --nvidia:#76b900;--nvidia-light:#f0fce4;--sbst:#e31837;
  --c65:#dc2626;--c131:#7c3aed;--c900:#0891b2;
  --shadow:0 1px 3px rgba(0,0,0,.08);--shadow-md:0 4px 16px rgba(0,0,0,.12);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;height:100vh;display:flex;flex-direction:column;overflow:hidden;}

/* HEADER */
header{display:flex;align-items:center;justify-content:space-between;padding:0 20px;height:54px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;box-shadow:var(--shadow);z-index:200;position:relative;}
.hd-left{display:flex;align-items:center;gap:14px;}
.logo{font-family:'Space Mono',monospace;font-size:15px;font-weight:700;color:var(--sbst);}
.logo-div{width:1px;height:24px;background:var(--border);}
.nv-badge{background:var(--nvidia-light);border:1px solid #b6e05a;border-radius:5px;padding:3px 9px;font-family:'Space Mono',monospace;font-size:9px;color:#4a7c00;letter-spacing:1px;font-weight:700;}
.hd-center{position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:8px;font-family:'Space Mono',monospace;font-size:11px;color:var(--muted);}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--accent2);box-shadow:0 0 0 2px var(--accent2-light);animation:blink 2s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
.hd-right{display:flex;align-items:center;gap:20px;}
.clock{font-family:'Space Mono',monospace;font-size:17px;color:var(--accent);letter-spacing:2px;font-weight:700;}
.kpis{display:flex;gap:18px;}
.kpi{text-align:center;}
.kpi-v{font-size:15px;font-weight:700;}
.kpi-l{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;}

/* MAIN GRID */
.main{display:grid;grid-template-columns:272px 1fr 322px;flex:1;overflow:hidden;}

/* LEFT PANEL */
.lp{background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
.tabs{display:flex;border-bottom:1px solid var(--border);background:var(--surface2);}
.tb{flex:1;padding:9px 4px;background:none;border:none;border-bottom:2px solid transparent;color:var(--muted);font-size:10px;cursor:pointer;font-family:'Space Mono',monospace;letter-spacing:.5px;transition:all .2s;}
.tb.on{color:var(--accent);border-bottom-color:var(--accent);background:var(--surface);}
.phdr{padding:10px 16px;border-bottom:1px solid var(--border);font-family:'Space Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;display:flex;align-items:center;justify-content:space-between;background:var(--surface2);}
.bdg{background:var(--warning);color:#fff;border-radius:10px;padding:1px 7px;font-size:9px;font-weight:700;}
.scroll{flex:1;overflow-y:auto;}
.scroll::-webkit-scrollbar{width:4px;}
.scroll::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

/* Incident filter chips */
.inc-filters{display:flex;gap:6px;padding:10px 14px;border-bottom:1px solid var(--border);flex-wrap:wrap;background:var(--surface);}
.f-chip{padding:4px 10px;border-radius:20px;border:1px solid var(--border);background:var(--surface2);font-size:10px;cursor:pointer;font-weight:600;transition:all .2s;display:flex;align-items:center;gap:4px;white-space:nowrap;}
.f-chip.on-acc{background:var(--danger-light);border-color:var(--danger);color:var(--danger);}
.f-chip.on-trf{background:var(--accent-light);border-color:var(--accent);color:var(--accent);}
.f-chip.on-wth{background:#e0f2fe;border-color:#0ea5e9;color:#0369a1;}
.f-chip.on-rdw{background:var(--warning-light);border-color:var(--warning);color:var(--warning);}
.f-chip-dot{width:6px;height:6px;border-radius:50%;}

/* Incident cards */
.ic{padding:11px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;border-left:4px solid transparent;}
.ic:hover{background:var(--surface2);}
.ic.sel{background:var(--accent-light);}
.ic-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;}
.ic-type{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;padding:2px 7px;border-radius:3px;}
.t-acc{background:var(--danger-light);color:var(--danger);}
.t-trf{background:var(--accent-light);color:var(--accent);}
.t-wth{background:#e0f2fe;color:#0369a1;}
.t-rdw{background:var(--warning-light);color:var(--warning);}
.ic-time{font-size:9px;color:var(--muted);font-family:'Space Mono',monospace;}
.ic-desc{font-size:12px;color:var(--text2);line-height:1.4;}
.ic-aff{font-size:10px;color:var(--muted);margin-top:3px;}
.ic-aff strong{color:var(--text2);font-weight:600;}
.ic-delay{font-size:10px;font-weight:700;margin-top:2px;}
.rr-btn{margin-top:8px;padding:5px 12px;border:none;border-radius:5px;color:#fff;font-size:10px;font-weight:700;cursor:pointer;font-family:'Space Mono',monospace;letter-spacing:.5px;transition:all .2s;}
.rr-btn:hover{filter:brightness(1.1);}
.rr-btn.done{background:var(--accent2)!important;cursor:default;}

/* Route color swatches */
.route-swatch{display:inline-block;width:10px;height:10px;border-radius:2px;margin-right:4px;vertical-align:middle;}

/* CENTER */
.cp{display:flex;flex-direction:column;overflow:hidden;position:relative;}
.toolbar{display:flex;align-items:center;gap:6px;flex-wrap:wrap;padding:8px 12px;background:var(--surface);border-bottom:1px solid var(--border);}
.tb2{padding:5px 11px;border-radius:5px;border:1.5px solid var(--border);background:var(--surface2);color:var(--muted);font-size:10px;cursor:pointer;font-family:'Space Mono',monospace;transition:all .2s;display:flex;align-items:center;gap:5px;font-weight:600;}
.tb2.active{background:var(--surface);box-shadow:0 1px 4px rgba(0,0,0,.1);}
.tb2.acc.active{border-color:var(--danger);color:var(--danger);}
.tb2.trf.active{border-color:var(--accent);color:var(--accent);}
.tb2.wth.active{border-color:#0ea5e9;color:#0369a1;}
.tb2.rdw.active{border-color:var(--warning);color:var(--warning);}
.tb2.buses.active{border-color:var(--accent2);color:var(--accent2);}
.dind{width:7px;height:7px;border-radius:50%;}
.map-hint{margin-left:auto;font-size:10px;color:var(--muted);font-family:'Space Mono',monospace;}
#map{flex:1;min-height:0;}

/* Legend */
.legend{position:absolute;bottom:14px;left:14px;background:rgba(255,255,255,.97);border:1px solid var(--border);border-radius:8px;padding:12px 14px;z-index:500;box-shadow:var(--shadow-md);}
.leg-t{font-family:'Space Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:1px;margin-bottom:8px;text-transform:uppercase;}
.leg-r{display:flex;align-items:center;gap:8px;margin-bottom:5px;font-size:11px;color:var(--text2);}
.ldot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.lline{width:22px;height:4px;border-radius:2px;flex-shrink:0;}
.ldash{width:22px;height:0;border-top:3px dashed currentColor;flex-shrink:0;}

/* Computing overlay */
.cov{position:absolute;inset:0;background:rgba(255,255,255,.95);z-index:400;display:none;align-items:center;justify-content:center;flex-direction:column;gap:14px;backdrop-filter:blur(4px);}
.cov.show{display:flex;}
.prog-o{width:300px;height:5px;background:var(--border);border-radius:3px;overflow:hidden;}
.prog-i{height:100%;background:linear-gradient(90deg,var(--nvidia),var(--accent));border-radius:3px;width:0%;transition:width .3s;}

/* RIGHT CHAT */
.rp{background:var(--surface);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
.ch-hdr{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;background:var(--surface2);}
.ai-av{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,#76b900,#0066cc);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.ch-t{font-weight:700;font-size:13px;}
.ch-s{font-size:10px;color:var(--muted);}
.ch-on{margin-left:auto;display:flex;align-items:center;gap:5px;font-size:10px;color:var(--accent2);font-weight:600;}
.msgs{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:12px;}
.msgs::-webkit-scrollbar{width:4px;}
.msgs::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.msg{display:flex;gap:8px;align-items:flex-start;}
.msg.u{flex-direction:row-reverse;}
.mav{width:26px;height:26px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;margin-top:2px;}
.mav.ai{background:linear-gradient(135deg,#76b900,#0066cc);}
.mav.u{background:var(--surface2);border:1px solid var(--border);}
.bub{max-width:245px;padding:9px 12px;border-radius:10px;font-size:12px;line-height:1.6;}
.msg.ai .bub{background:var(--surface2);border:1px solid var(--border);border-top-left-radius:3px;}
.msg.u .bub{background:var(--accent);color:#fff;border-top-right-radius:3px;}
.mt{font-size:9px;color:var(--muted);margin-top:3px;font-family:'Space Mono',monospace;}
.msg.u .mt{text-align:right;}
.chip{display:inline-block;background:var(--nvidia-light);border:1px solid #b6e05a;border-radius:12px;padding:3px 10px;font-size:10px;color:#4a7c00;margin:3px 3px 0 0;cursor:pointer;}
.chip:hover{background:#d4f0a0;}
.qacts{padding:8px 14px;border-top:1px solid var(--border);display:flex;flex-wrap:wrap;gap:5px;background:var(--surface2);}
.qb{font-size:10px;padding:4px 10px;background:var(--surface);border:1px solid var(--border);border-radius:12px;color:var(--muted);cursor:pointer;transition:all .2s;}
.qb:hover{border-color:var(--accent);color:var(--accent);}
.cin-area{padding:12px 14px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:center;}
.cin{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:8px 12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:12px;outline:none;height:38px;transition:border-color .2s;}
.cin:focus{border-color:var(--accent);}
.cin::placeholder{color:var(--muted);}
.sbtn{width:38px;height:38px;border-radius:7px;background:var(--accent);border:none;color:#fff;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.sbtn:hover{background:#0052a3;}
.typing{display:flex;gap:4px;align-items:center;}
.typing span{width:6px;height:6px;background:var(--muted);border-radius:50%;animation:bounce 1.2s infinite;}
.typing span:nth-child(2){animation-delay:.2s;}
.typing span:nth-child(3){animation-delay:.4s;}
@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}

/* Savings panel in chat (replaces modal) */
.savings-panel{background:var(--nvidia-light);border:1px solid #b6e05a;border-radius:8px;padding:10px 12px;margin-top:6px;font-size:11px;}
.sp-title{font-family:'Space Mono',monospace;font-size:9px;color:#4a7c00;letter-spacing:1px;margin-bottom:8px;font-weight:700;}
.sp-row{display:flex;justify-content:space-between;align-items:center;padding:3px 0;border-bottom:1px solid rgba(0,0,0,.06);}
.sp-row:last-child{border-bottom:none;}
.sp-lbl{color:var(--text2);}
.sp-val{font-weight:700;color:#4a7c00;font-family:'Space Mono',monospace;font-size:10px;}
.sp-total{background:#d4f0a0;border-radius:5px;padding:6px 8px;margin-top:6px;display:flex;justify-content:space-between;align-items:center;}
.sp-total-lbl{font-size:10px;color:#2d5a00;font-weight:600;}
.sp-total-val{font-family:'Space Mono',monospace;font-size:14px;color:#2d5a00;font-weight:700;}
.deploy-inline{margin-top:7px;width:100%;padding:7px;background:var(--nvidia);border:none;border-radius:5px;color:#fff;font-weight:700;font-family:'Space Mono',monospace;font-size:10px;cursor:pointer;letter-spacing:.5px;}
.deploy-inline:hover{background:#5a9900;}

/* STATS BAR */
.sbar{display:flex;align-items:center;height:36px;background:var(--surface);border-top:1px solid var(--border);flex-shrink:0;padding:0 16px;overflow:hidden;}
.si{display:flex;align-items:center;gap:8px;padding:0 14px;border-right:1px solid var(--border);white-space:nowrap;}
.si:first-child{padding-left:0;}
.sl{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;}
.sv{font-family:'Space Mono',monospace;font-size:12px;font-weight:700;}

/* TOAST */
.toast{position:fixed;top:62px;right:330px;background:var(--surface);border:1px solid var(--border);border-left:4px solid var(--warning);border-radius:8px;padding:10px 14px;z-index:1000;box-shadow:var(--shadow-md);font-size:12px;max-width:260px;transform:translateY(-8px);opacity:0;transition:all .3s;pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}
.toast-title{font-weight:700;margin-bottom:3px;font-size:11px;}
.toast-msg{color:var(--text2);line-height:1.4;}

/* LTA DataMall info box */
.lta-box{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-top:8px;font-size:11px;line-height:1.8;}
.lta-box strong{color:var(--text);}
.lta-tag{display:inline-block;background:var(--accent-light);border:1px solid #93c5fd;border-radius:3px;padding:1px 5px;font-size:9px;color:var(--accent);font-weight:700;margin-right:2px;font-family:'Space Mono',monospace;}
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="hd-left">
    <div class="logo">SBS Transit</div>
    <div class="logo-div"></div>
    <div class="nv-badge">‚ö° NVIDIA cuOPT‚Ñ¢</div>
  </div>
  <div class="hd-center"><div class="live-dot"></div><span>NETWORK COMMAND CENTRE ‚Äî LIVE</span></div>
  <div class="hd-right">
    <div class="kpis">
      <div class="kpi"><div class="kpi-v" style="color:var(--accent)">412</div><div class="kpi-l">Buses Live</div></div>
      <div class="kpi"><div class="kpi-v" style="color:var(--danger)">3</div><div class="kpi-l">Need Reroute</div></div>
      <div class="kpi"><div class="kpi-v" style="color:#4a7c00" id="optSaving">‚Äî</div><div class="kpi-l">cuOPT Saved</div></div>
    </div>
    <div class="clock" id="clock">--:--:--</div>
  </div>
</header>

<!-- MAIN -->
<div class="main">

  <!-- LEFT PANEL -->
  <div class="lp">
    <div class="tabs">
      <button class="tb on" onclick="swTab('dis',this)">DISRUPTIONS</button>
      <button class="tb" onclick="swTab('status',this)">cuOPT STATUS</button>
      <button class="tb" onclick="swTab('lta',this)">LTA DATA</button>
    </div>

    <!-- DISRUPTIONS TAB -->
    <div id="tab-dis" class="scroll">
      <div class="phdr">Filter by Incident Type <span class="bdg">3 routes</span></div>

      <!-- Filter chips -->
      <div class="inc-filters">
        <div class="f-chip on-acc" id="fc-acc" onclick="filterInc('acc')">
          <span class="f-chip-dot" style="background:var(--danger)"></span>Accident
        </div>
        <div class="f-chip on-trf" id="fc-trf" onclick="filterInc('trf')">
          <span class="f-chip-dot" style="background:var(--accent)"></span>Congestion
        </div>
        <div class="f-chip on-wth" id="fc-wth" onclick="filterInc('wth')">
          <span class="f-chip-dot" style="background:#0ea5e9"></span>Weather
        </div>
        <div class="f-chip on-rdw" id="fc-rdw" onclick="filterInc('rdw')">
          <span class="f-chip-dot" style="background:var(--warning)"></span>Roadworks
        </div>
      </div>

      <!-- Bus 65 ‚Äî Accident (red) -->
      <div class="ic sel" id="card-65" data-type="acc" onclick="selInc('65',this)" style="border-left-color:var(--c65)">
        <div class="ic-head">
          <span class="ic-type t-acc">üö® ACCIDENT</span>
          <span class="ic-time">08:23</span>
        </div>
        <div class="ic-desc">ECP near Bedok Interchange ‚Äî 3-vehicle collision, 2 lanes blocked</div>
        <div class="ic-aff">Route: <span class="route-swatch" style="background:var(--c65)"></span><strong>Bus 65</strong></div>
        <div class="ic-delay" style="color:var(--c65)">+18 min delay ¬∑ 8 buses affected</div>
        <button class="rr-btn" id="btn-65" style="background:var(--c65)" onclick="event.stopPropagation();doReroute('65')">‚ö° cuOPT Re-route</button>
      </div>

      <!-- Bus 131 ‚Äî Congestion (purple) -->
      <div class="ic" id="card-131" data-type="trf" onclick="selInc('131',this)" style="border-left-color:var(--c131)">
        <div class="ic-head">
          <span class="ic-type t-trf">üî¥ CONGESTION</span>
          <span class="ic-time">07:45</span>
        </div>
        <div class="ic-desc">CTE northbound ‚Äî heavy congestion 6km, Braddell to PIE junction</div>
        <div class="ic-aff">Route: <span class="route-swatch" style="background:var(--c131)"></span><strong>Bus 131</strong></div>
        <div class="ic-delay" style="color:var(--c131)">+22 min delay ¬∑ 7 buses affected</div>
        <button class="rr-btn" id="btn-131" style="background:var(--c131)" onclick="event.stopPropagation();doReroute('131')">‚ö° cuOPT Re-route</button>
      </div>

      <!-- Bus 900 ‚Äî Weather (blue) -->
      <div class="ic" id="card-900" data-type="wth" onclick="selInc('900',this)" style="border-left-color:var(--c900)">
        <div class="ic-head">
          <span class="ic-type t-wth">‚õàÔ∏è WEATHER</span>
          <span class="ic-time">08:10</span>
        </div>
        <div class="ic-desc">Flash flooding at Woodlands Ave 12 ‚Äî road partially submerged</div>
        <div class="ic-aff">Route: <span class="route-swatch" style="background:var(--c900)"></span><strong>Bus 900</strong></div>
        <div class="ic-delay" style="color:var(--c900)">+25 min delay ¬∑ 10 buses affected</div>
        <button class="rr-btn" id="btn-900" style="background:var(--c900)" onclick="event.stopPropagation();doReroute('900')">‚ö° cuOPT Re-route</button>
      </div>

      <!-- Other incidents (no reroute needed) -->
      <div class="phdr" style="margin-top:2px">Other Active Incidents (no reroute required)</div>
      <div style="padding:12px 16px;font-size:11px;color:var(--text2);line-height:2;border-bottom:1px solid var(--border)">
        <span class="ic-type t-rdw" style="font-size:9px">üöß ROADWORKS</span>&nbsp; Geylang Rd ‚Äî Bus 65, 67 minor delay<br>
        <span class="ic-type t-trf" style="font-size:9px">üî¥ CONGESTION</span>&nbsp; PIE/Bukit Batok ‚Äî Bus 173, 174<br>
        <span class="ic-type t-wth" style="font-size:9px">‚õàÔ∏è WEATHER</span>&nbsp;&nbsp; Tampines Ave 10 ‚Äî Bus 291, 292<br>
        <span class="ic-type t-rdw" style="font-size:9px">üöß ROADWORKS</span>&nbsp; Marina Bay MRT ‚Äî Bus 10, 30
      </div>
    </div>

    <!-- cuOPT STATUS TAB -->
    <div id="tab-status" class="scroll" style="display:none">
      <div class="phdr">NVIDIA cuOPT Engine</div>
      <div style="padding:14px">
        <div style="background:var(--nvidia-light);border:1px solid #b6e05a;border-radius:8px;padding:12px;margin-bottom:14px">
          <div style="font-family:'Space Mono',monospace;font-size:9px;color:#4a7c00;letter-spacing:1px;margin-bottom:6px">‚ö° GPU-ACCELERATED VRP SOLVER</div>
          <div style="font-size:11px;color:var(--text2);line-height:1.65">cuOPT uses NVIDIA GPU parallel computing to solve Vehicle Routing Problems in <strong>under 1 second</strong> versus hours on CPU-based solvers.</div>
        </div>
        <div style="margin-bottom:14px">
          <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px">Live System Status</div>
          <div style="display:flex;flex-direction:column;gap:6px;font-size:11px">
            <div style="display:flex;justify-content:space-between"><span>GPU Cluster (8√ó A100)</span><span style="color:var(--accent2);font-weight:600">‚óè Online</span></div>
            <div style="display:flex;justify-content:space-between"><span>Fleet telemetry feed</span><span style="color:var(--accent2);font-weight:600">‚óè Live</span></div>
            <div style="display:flex;justify-content:space-between"><span>LTA DataMall API</span><span style="color:var(--accent2);font-weight:600">‚óè Synced</span></div>
            <div style="display:flex;justify-content:space-between"><span>OneMap SLA routing</span><span style="color:var(--accent2);font-weight:600">‚óè Active</span></div>
          </div>
        </div>
        <div id="session-results" style="display:none;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:14px">
          <div style="font-family:'Space Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:1px;margin-bottom:8px">SESSION RESULTS</div>
          <div id="session-content" style="font-size:11px;color:var(--text2);line-height:1.9"></div>
        </div>
        <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px">Optimisation Capabilities</div>
        <div style="font-size:11px;color:var(--text2);line-height:1.9">
          ‚úÖ Road-network-aware re-routing<br>
          ‚úÖ Fleet headway balancing<br>
          ‚úÖ Driver schedule constraints<br>
          ‚úÖ Passenger demand weighting<br>
          ‚úÖ Multi-objective cost minimisation<br>
          ‚úÖ Real-time incident zone exclusion
        </div>
      </div>
    </div>

    <!-- LTA DATAMALL TAB -->
    <div id="tab-lta" class="scroll" style="display:none">
      <div class="phdr">LTA DataMall ‚Äî Data Used</div>
      <div style="padding:14px;font-size:12px;color:var(--text2);line-height:1.7">
        <div style="font-weight:700;margin-bottom:8px;color:var(--text)">This demo simulates the following LTA DataMall datasets:</div>

        <div style="margin-bottom:14px">
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--accent);margin-bottom:6px">Real-Time Dynamic Data</div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <div><span class="lta-tag">BUS_ARRIVAL</span> Bus Arrival API ‚Äî live ETA per stop, used to compute current delays shown on each route card</div>
            <div><span class="lta-tag">TRAFFIC_INCIDENTS</span> Traffic Incidents ‚Äî accident, congestion, roadworks events; drives the 3 disruption cards</div>
            <div><span class="lta-tag">TRAFFIC_SPEEDBAND</span> Traffic Speed Bands ‚Äî road segment speeds; cuOPT uses this to build the travel-time cost matrix for re-routing</div>
            <div><span class="lta-tag">VEH_LOCATION</span> Bus Location (GPS) ‚Äî real-time lat/lng of each bus; animates the üöå markers on the map</div>
          </div>
        </div>

        <div style="margin-bottom:14px">
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--accent);margin-bottom:6px">Static Reference Data</div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <div><span class="lta-tag">BUS_ROUTES</span> Bus Routes ‚Äî stop sequences per service; defines which stops Bus 65, 131, 900 serve</div>
            <div><span class="lta-tag">BUS_STOPS</span> Bus Stop locations ‚Äî lat/lng of all stops; used as waypoints in route geometry</div>
            <div><span class="lta-tag">PASSENGER_VOL</span> Passenger Volume by Bus Stop ‚Äî origin-destination demand; cuOPT weights routes to protect high-demand stops</div>
          </div>
        </div>

        <div style="margin-bottom:14px">
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--accent);margin-bottom:6px">Used via OneMap SLA</div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <div><span class="lta-tag">ROAD_NETWORK</span> Road Network Graph ‚Äî turn restrictions, lane counts, road hierarchy; OSRM uses this to draw road-following routes</div>
            <div><span class="lta-tag">GEOFENCE</span> Flood/Incident zone polygons ‚Äî excluded from cuOPT's permissible route set during active incidents</div>
          </div>
        </div>

        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:10px;font-size:10px;color:var(--muted);line-height:1.7">
          ‚ö†Ô∏è <strong>Note:</strong> This is a demonstration. In production, the app would call the <a href="https://datamall.lta.gov.sg" target="_blank" style="color:var(--accent)">LTA DataMall API</a> directly using an API key. All data shown (delays, bus positions, incidents) is <strong>simulated</strong> to represent realistic SBST network conditions.
        </div>
      </div>
    </div>
  </div>

  <!-- CENTER MAP -->
  <div class="cp">
    <div class="toolbar">
      <!-- Incident type filter buttons -->
      <button class="tb2 acc active" id="ml-acc" onclick="mapToggle('acc',this)"><span class="dind" style="background:var(--danger)"></span>Accidents</button>
      <button class="tb2 trf active" id="ml-trf" onclick="mapToggle('trf',this)"><span class="dind" style="background:var(--accent)"></span>Congestion</button>
      <button class="tb2 wth active" id="ml-wth" onclick="mapToggle('wth',this)"><span class="dind" style="background:#0ea5e9"></span>Weather</button>
      <button class="tb2 rdw active" id="ml-rdw" onclick="mapToggle('rdw',this)"><span class="dind" style="background:var(--warning)"></span>Roadworks</button>
      <div style="width:1px;height:20px;background:var(--border);margin:0 4px"></div>
      <button class="tb2 buses active" id="ml-buses" onclick="mapToggle('buses',this)"><span class="dind" style="background:var(--accent2)"></span>Live Buses</button>
      <div class="map-hint" id="maphint">Select a disruption ‚Üí click ‚ö° cuOPT Re-route</div>
    </div>

    <div id="map"></div>

    <div class="legend">
      <div class="leg-t">Legend</div>
      <div class="leg-r"><div class="lline" style="background:var(--c65)"></div>Bus 65 (accident)</div>
      <div class="leg-r"><div class="lline" style="background:var(--c131)"></div>Bus 131 (congestion)</div>
      <div class="leg-r"><div class="lline" style="background:var(--c900)"></div>Bus 900 (weather)</div>
      <div style="border-top:1px solid var(--border);margin:6px 0"></div>
      <div class="leg-r" style="font-size:10px;color:var(--muted);font-style:italic">After ‚ö° cuOPT Re-route:</div>
      <div class="leg-r"><div style="width:22px;height:0;border-top:4px dashed #888;flex-shrink:0"></div>Blocked section (dotted)</div>
      <div class="leg-r"><div style="width:22px;height:0;border-top:4px dashed #555;flex-shrink:0"></div>Bypass proposed (dotted)</div>
      <div class="leg-r"><div class="lline" style="background:#16a34a"></div><span style="color:#16a34a">‚úÖ</span> Bypass deployed (green)</div>
      <div style="border-top:1px solid var(--border);margin:6px 0"></div>
      <div class="leg-r"><span style="font-size:13px">üöå</span>Live Bus (GPS)</div>
      <div class="leg-r"><div class="ldot" style="background:var(--danger)"></div>Accident zone</div>
      <div class="leg-r"><div class="ldot" style="background:#0ea5e9"></div>Weather / flood zone</div>
    </div>

    <!-- Computing overlay -->
    <div class="cov" id="cov">
      <div style="font-size:42px">‚ö°</div>
      <div style="font-family:'Space Mono',monospace;font-size:16px;color:#4a7c00;letter-spacing:2px">cuOPT COMPUTING</div>
      <div style="font-size:12px;color:var(--muted)" id="covSt">Initialising...</div>
      <div class="prog-o"><div class="prog-i" id="progBar"></div></div>
    </div>
  </div>

  <!-- RIGHT PANEL ‚Äî CHAT -->
  <div class="rp">
    <div class="ch-hdr">
      <div class="ai-av">ü§ñ</div>
      <div>
        <div class="ch-t">SBST AI Operator</div>
        <div class="ch-s">cuOPT + LTA DataMall + OneMap SLA</div>
      </div>
      <div class="ch-on"><div class="live-dot"></div>Online</div>
    </div>

    <div class="msgs" id="chatMsgs">
      <div class="msg ai">
        <div class="mav ai">ü§ñ</div>
        <div>
          <div class="bub">
            Good morning! Monitoring <strong>412 active buses</strong> across the SBST network.<br><br>
            I've identified <strong>3 routes</strong> requiring re-optimisation due to active disruptions:<br><br>
            <span style="color:var(--c65)">‚ñ†</span> <strong>Bus 65</strong> ‚Äî ECP accident (+18 min)<br>
            <span style="color:var(--c131)">‚ñ†</span> <strong>Bus 131</strong> ‚Äî CTE congestion (+22 min)<br>
            <span style="color:var(--c900)">‚ñ†</span> <strong>Bus 900</strong> ‚Äî Woodlands flood (+25 min)<br><br>
            Each route is shown on the map in its own colour. Click <strong>‚ö° cuOPT Re-route</strong> on any card to compute an optimised alternate path.
            <div style="margin-top:8px">
              <span class="chip" onclick="sendQ('Reroute Bus 65 around the ECP accident')">Reroute Bus 65</span>
              <span class="chip" onclick="sendQ('Reroute Bus 131 around CTE congestion')">Reroute Bus 131</span>
              <span class="chip" onclick="sendQ('Reroute Bus 900 around Woodlands flood')">Reroute Bus 900</span>
            </div>
          </div>
          <div class="mt">08:31:02</div>
        </div>
      </div>
    </div>

    <div class="qacts">
      <button class="qb" onclick="sendQ('How is the saving calculated?')">How savings work?</button>
      <button class="qb" onclick="sendQ('Which route has the worst delay?')">Worst delay?</button>
      <button class="qb" onclick="sendQ('What is the total saving if I reroute all 3?')">Total savings?</button>
      <button class="qb" onclick="sendQ('What LTA data is used in this demo?')">LTA data?</button>
    </div>

    <div class="cin-area">
      <input class="cin" id="chatInput" placeholder="Ask about routes, savings, re-routing..." onkeydown="if(event.key==='Enter')sendMessage()">
      <button class="sbtn" onclick="sendMessage()">‚û§</button>
    </div>
  </div>
</div>

<!-- STATS BAR -->
<div class="sbar">
  <div class="si"><span class="sl">Buses Active</span><span class="sv" style="color:var(--accent)">412/450</span></div>
  <div class="si"><span class="sl">Routes Disrupted</span><span class="sv" style="color:var(--danger)">3</span></div>
  <div class="si"><span class="sl">Reroutes Done</span><span class="sv" style="color:#4a7c00" id="rrCount">0 / 3</span></div>
  <div class="si"><span class="sl">Daily Savings</span><span class="sv" style="color:var(--accent2)" id="totSav">S$0</span></div>
  <div class="si"><span class="sl">Avg Delay Saved</span><span class="sv" style="color:var(--warning)" id="avgDel">‚Äî</span></div>
  <div class="si"><span class="sl">Solve Time</span><span class="sv" style="color:#4a7c00" id="solveT">‚Äî</span></div>
  <div class="si"><span class="sl">Pax Benefitting</span><span class="sv" style="color:var(--accent)" id="paxB">‚Äî</span></div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"><div class="toast-title" id="toastTtl"></div><div class="toast-msg" id="toastMsg"></div></div>

<script>
/* ==============================
   CLOCK
============================== */
function updClock(){document.getElementById('clock').textContent=new Date().toLocaleTimeString('en-SG',{hour12:false});}
setInterval(updClock,1000);updClock();

/* ==============================
   TOAST
============================== */
function toast(title,msg,color){
  var t=document.getElementById('toast');
  document.getElementById('toastTtl').textContent=title;
  document.getElementById('toastMsg').textContent=msg;
  t.style.borderLeftColor=color||'var(--warning)';
  t.style.color=color||'var(--warning)';
  document.getElementById('toastTtl').style.color=color||'var(--warning)';
  t.classList.add('show');
  clearTimeout(t._t);
  t._t=setTimeout(function(){t.classList.remove('show');},5000);
}

/* ==============================
   TAB SWITCHING
============================== */
window.swTab=function(tab,btn){
  ['dis','status','lta'].forEach(function(t){document.getElementById('tab-'+t).style.display=t===tab?'block':'none';});
  document.querySelectorAll('.tb').forEach(function(b){b.classList.remove('on');});
  btn.classList.add('on');
};

/* ==============================
   INCIDENT FILTER (left panel cards)
============================== */
var filterState={acc:true,trf:true,wth:true,rdw:true};
window.filterInc=function(type){
  filterState[type]=!filterState[type];
  var chip=document.getElementById('fc-'+type);
  // Toggle chip visual
  chip.className='f-chip'+(filterState[type]?' on-'+type:'');
  // Show/hide cards
  document.querySelectorAll('.ic[data-type="'+type+'"]').forEach(function(c){
    c.style.display=filterState[type]?'':'none';
  });
  // Also toggle map layer
  syncMapLayerFromFilter(type,filterState[type]);
};

/* ==============================
   ROUTE DATA
   splitIdx: index in wp[] where incident zone STARTS (before = 0..splitIdx, incident = splitIdx..splitEndIdx, after = splitEndIdx..end)
   splitEndIdx: index where incident zone ENDS and normal route resumes
   bypassWp: extra road points that go AROUND the incident, connecting wp[splitIdx] to wp[splitEndIdx]
============================== */
var ROUTES={
  '65':{
    color:'#dc2626',
    label:'Bus 65 ‚Äî Tampines Int ‚Üí Bedok Int (via ECP)',
    // Full route waypoints
    wp:[
      [1.3521,103.9401], // 0 Tampines Int
      [1.3350,103.9150], // 1
      [1.3181,103.9000], // 2
      [1.3100,103.8850], // 3  ‚Üê incident starts here
      [1.3081,103.8680], // 4  ‚Üê accident site
      [1.3050,103.8600], // 5  ‚Üê incident ends here
      [1.3081,103.8518]  // 6 Bedok Int
    ],
    splitIdx:3, splitEndIdx:5,
    // Bypass: from wp[3] go via Bedok North Rd, rejoin at wp[5]
    bypassWp:[
      [1.3100,103.8850], // join point from normal route
      [1.3160,103.8780],
      [1.3140,103.8680],
      [1.3080,103.8620],
      [1.3050,103.8600]  // rejoin normal route
    ],
    inc:{lat:1.3081,lng:103.8680,type:'acc',emoji:'üö®',desc:'3-vehicle collision ‚Äî 2 lanes blocked on ECP'},
    delay:18, pax:1240, buses:8, solveRoutes:6820,
    altLabel:'Bedok North Rd bypass (avoids ECP accident)',
    kmOrig:14.2, kmAlt:11.8,
    fuelSave:18.40, ltaPenalty:162, passPenalty:0, overtime:0
  },
  '131':{
    color:'#7c3aed',
    label:'Bus 131 ‚Äî Toa Payoh Int ‚Üí Yishun Int (via CTE)',
    wp:[
      [1.3320,103.8480], // 0 Toa Payoh Int
      [1.3480,103.8380], // 1  ‚Üê incident starts (CTE on-ramp)
      [1.3620,103.8260], // 2  ‚Üê congestion zone
      [1.3780,103.8200], // 3  ‚Üê incident ends (PIE junction)
      [1.4100,103.8280], // 4
      [1.4296,103.8353]  // 5 Yishun Int
    ],
    splitIdx:1, splitEndIdx:3,
    // Bypass: Upper Thomson Rd off CTE, avoids Braddell‚ÄìPIE congestion
    bypassWp:[
      [1.3480,103.8380], // join
      [1.3520,103.8260],
      [1.3580,103.8140],
      [1.3700,103.8090],
      [1.3780,103.8200]  // rejoin
    ],
    inc:{lat:1.3620,lng:103.8260,type:'trf',emoji:'üî¥',desc:'CTE congestion 6km ‚Äî Braddell to PIE junction'},
    delay:22, pax:980, buses:7, solveRoutes:5940,
    altLabel:'Upper Thomson Rd bypass (avoids CTE congestion)',
    kmOrig:16.8, kmAlt:18.1,
    fuelSave:23.60, ltaPenalty:198, passPenalty:0, overtime:45
  },
  '900':{
    color:'#0891b2',
    label:'Bus 900 ‚Äî Woodlands Int ‚Üí City Hall',
    wp:[
      [1.4382,103.7890], // 0 Woodlands Int
      [1.4200,103.7960], // 1  ‚Üê incident starts (Woodlands Ave 12)
      [1.4044,103.7996], // 2  ‚Üê flood site
      [1.3900,103.7900], // 3  ‚Üê incident ends
      [1.3500,103.8000], // 4
      [1.2897,103.8516]  // 5 City Hall
    ],
    splitIdx:1, splitEndIdx:3,
    // Bypass: Admiralty Rd East, avoids flooded Woodlands Ave 12
    bypassWp:[
      [1.4200,103.7960], // join
      [1.4280,103.8060],
      [1.4200,103.8180],
      [1.4050,103.8100],
      [1.3900,103.7900]  // rejoin
    ],
    inc:{lat:1.4044,lng:103.7996,type:'wth',emoji:'‚õàÔ∏è',desc:'Flash flooding ‚Äî Woodlands Ave 12 partially submerged'},
    delay:25, pax:1450, buses:10, solveRoutes:8210,
    altLabel:'Admiralty Rd East bypass (avoids flood zone)',
    kmOrig:19.4, kmAlt:21.2,
    fuelSave:16.10, ltaPenalty:225, passPenalty:290, overtime:68
  }
};

/* Total per-trip saving calc */
function calcSaving(k){
  var r=ROUTES[k];
  return r.fuelSave+r.ltaPenalty+r.passPenalty+r.overtime;
}

/* ==============================
   CHAT
============================== */
function gt(){return new Date().toLocaleTimeString('en-SG',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});}
function fmt(s){return s.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');}
function addAi(html,raw){
  var el=document.createElement('div');el.className='msg ai';
  el.innerHTML='<div class="mav ai">ü§ñ</div><div><div class="bub">'+( raw?html:fmt(html) )+'</div><div class="mt">'+gt()+'</div></div>';
  document.getElementById('chatMsgs').appendChild(el);scrl();return el;
}
function addUser(t){
  document.getElementById('chatMsgs').insertAdjacentHTML('beforeend','<div class="msg u"><div class="mav u">üë§</div><div><div class="bub">'+t.replace(/</g,'&lt;')+'</div><div class="mt">'+gt()+'</div></div></div>');scrl();
}
function addTyping(){
  var id='ty'+Date.now();
  document.getElementById('chatMsgs').insertAdjacentHTML('beforeend','<div class="msg ai" id="'+id+'"><div class="mav ai">ü§ñ</div><div class="bub"><div class="typing"><span></span><span></span><span></span></div></div></div>');
  scrl();return id;
}
function scrl(){var c=document.getElementById('chatMsgs');c.scrollTop=c.scrollHeight;}

/* --- Build savings panel HTML (shown in chat) --- */
function savingsHTML(k){
  var r=ROUTES[k];
  var total=calcSaving(k);
  var daily=total*( k==='65'?28:k==='131'?24:32 );
  var html='<div class="savings-panel">'
    +'<div class="sp-title">‚ö° cuOPT SAVINGS ‚Äî BUS '+k+'</div>'
    +'<div class="sp-row"><span class="sp-lbl">‚è± Delay reduced</span><span class="sp-val">+'+r.delay+' min ‚Üí &lt;3 min</span></div>'
    +'<div class="sp-row"><span class="sp-lbl">üí∏ LTA delay penalty avoided</span><span class="sp-val">S$'+r.ltaPenalty+'/trip</span></div>'
    +'<div class="sp-row"><span class="sp-lbl">‚õΩ Fuel saving (shorter route)</span><span class="sp-val">S$'+r.fuelSave.toFixed(2)+'/trip</span></div>'
    +(r.overtime>0?'<div class="sp-row"><span class="sp-lbl">üë§ Driver overtime avoided</span><span class="sp-val">S$'+r.overtime+'/trip</span></div>':'')
    +(r.passPenalty>0?'<div class="sp-row"><span class="sp-lbl">üé´ Pax compensation avoided</span><span class="sp-val">S$'+r.passPenalty+'/trip</span></div>':'')
    +'<div class="sp-row"><span class="sp-lbl">üìè Route: '+r.kmOrig+' km ‚Üí '+r.kmAlt+' km</span><span class="sp-val">via '+r.altLabel+'</span></div>'
    +'<div class="sp-total"><span class="sp-total-lbl">Total saving/trip</span><span class="sp-total-val">S$'+total.toLocaleString()+'</span></div>'
    +'<div class="sp-total" style="margin-top:4px"><span class="sp-total-lbl">Projected daily saving</span><span class="sp-total-val">S$'+daily.toLocaleString()+'</span></div>'
    +'<div style="font-size:10px;color:#2d5a00;margin-top:6px;line-height:1.6"><strong>How calculated:</strong> LTA delay penalty (S$9/late-min) + fuel saved on shorter/uncongested road + driver overtime avoided + passenger compensation vouchers (if delay &gt;20 min). cuOPT minimises this total cost across '+r.solveRoutes.toLocaleString()+' route permutations on GPU.</div>'
    +'<button class="deploy-inline" onclick="deployRoute(\''+k+'\')">‚úÖ DEPLOY THIS RE-ROUTE</button>'
    +'</div>';
  return html;
}

/* --- Response logic --- */
var RESP={
  savings:'**How cuOPT savings are calculated:**\n\n**1. LTA Delay Penalty** ‚Äî SBST pays LTA ~S$9 per late minute per trip for buses over 5 min behind schedule.\n\n**2. Fuel Cost** ‚Äî Idling in jams burns fuel unproductively. Shorter or uncongested re-routes cut this directly.\n\n**3. Driver Overtime** ‚Äî Delays push drivers past shift limits, triggering overtime pay (+S$18‚Äì25/hr).\n\n**4. Passenger Compensation** ‚Äî Delays over 20 min trigger goodwill vouchers (~S$0.20/pax).\n\ncuOPT sums all four costs and finds the route minimising the total, evaluated across thousands of permutations simultaneously on GPU ‚Äî in under 1 second.',
  worst:'**Bus 900 has the worst delay** at +25 min, affecting ~1,450 passengers due to Woodlands flooding.\n\nRanking:\nüîµ Bus 900 ‚Äî +25 min (weather)\nüü£ Bus 131 ‚Äî +22 min (congestion)\nüî¥ Bus 65 ‚Äî +18 min (accident)\n\nClick ‚ö° cuOPT Re-route on any card to compute the optimised path.',
  total:'**If all 3 routes are re-routed:**\n\nüî¥ Bus 65 ‚Äî S$180/trip √ó 28 trips = **S$5,040/day**\nüü£ Bus 131 ‚Äî S$267/trip √ó 24 trips = **S$6,408/day**\nüîµ Bus 900 ‚Äî S$599/trip √ó 32 trips = **S$19,168/day**\n\n**Total: ~S$30,616/day**\n\ncuOPT solved all 3 simultaneously in under 1 second on GPU.',
  lta:'**LTA DataMall datasets used in this demo:**\n\n**Real-time:**\n‚Ä¢ BUS_ARRIVAL ‚Äî live ETAs to compute delays\n‚Ä¢ TRAFFIC_INCIDENTS ‚Äî feeds the 3 disruption cards\n‚Ä¢ TRAFFIC_SPEEDBAND ‚Äî road speeds for cuOPT cost matrix\n‚Ä¢ VEH_LOCATION ‚Äî GPS positions animating the üöå buses\n\n**Static:**\n‚Ä¢ BUS_ROUTES ‚Äî stop sequences per service\n‚Ä¢ BUS_STOPS ‚Äî stop lat/lng as route waypoints\n‚Ä¢ PASSENGER_VOL ‚Äî demand weighting in cuOPT\n\n**Via OneMap SLA:**\n‚Ä¢ Road network graph (turn restrictions, road hierarchy)\n‚Ä¢ Flood/incident zone geofences\n\nSee the **LTA Data** tab for full details.',
  reroute:'Initiating cuOPT re-route computation...',
  def:'I\'m monitoring **3 disrupted routes** on the live network.\n\nUse ‚ö° cuOPT Re-route buttons on each card to compute GPU-optimised alternate paths and see a savings breakdown in this chat. Or ask me:\n‚Ä¢ "How are savings calculated?"\n‚Ä¢ "Which route is worst?"\n‚Ä¢ "What LTA data is used?"'
};

function getResp(msg){
  var m=msg.toLowerCase();
  if(m.includes('saving')||m.includes('calculat')||m.includes('how')) return RESP.savings;
  if(m.includes('worst')||m.includes('delay')||m.includes('bad')) return RESP.worst;
  if(m.includes('total')||m.includes('all 3')||m.includes('all three')) return RESP.total;
  if(m.includes('lta')||m.includes('data')) return RESP.lta;
  if(m.includes('65')){setTimeout(function(){doReroute('65');},800);return 'Computing cuOPT re-route for **Bus 65** around the ECP accident...';}
  if(m.includes('131')){setTimeout(function(){doReroute('131');},800);return 'Computing cuOPT re-route for **Bus 131** around CTE congestion...';}
  if(m.includes('900')){setTimeout(function(){doReroute('900');},800);return 'Computing cuOPT re-route for **Bus 900** around Woodlands flooding...';}
  return RESP.def;
}

window.sendMessage=function(){
  var inp=document.getElementById('chatInput');
  var text=inp.value.trim();if(!text)return;
  inp.value='';addUser(text);
  var tid=addTyping();
  setTimeout(function(){
    var el=document.getElementById(tid);if(el)el.remove();
    addAi(getResp(text));
  },900+Math.random()*400);
};
window.sendQ=function(t){document.getElementById('chatInput').value=t;sendMessage();};

/* ==============================
   STATS BAR
============================== */
var doneRoutes={};
var totalSaved=0;
function updateStats(){
  var n=Object.keys(doneRoutes).length;
  var delSaved=[];
  var pax=0;
  totalSaved=0;
  Object.keys(doneRoutes).forEach(function(k){
    var r=ROUTES[k];var s=calcSaving(k);
    totalSaved+=s*(k==='65'?28:k==='131'?24:32);
    delSaved.push(r.delay-3);pax+=r.pax;
  });
  document.getElementById('rrCount').textContent=n+' / 3';
  document.getElementById('totSav').textContent=totalSaved>0?'S$'+totalSaved.toLocaleString():'S$0';
  document.getElementById('optSaving').textContent=totalSaved>0?'S$'+totalSaved.toLocaleString():'‚Äî';
  document.getElementById('avgDel').textContent=delSaved.length?Math.round(delSaved.reduce(function(a,b){return a+b;},0)/delSaved.length)+' min':'‚Äî';
  document.getElementById('paxB').textContent=pax>0?pax.toLocaleString()+' pax':'‚Äî';
  if(n>0){
    var sc='';Object.keys(doneRoutes).forEach(function(k){var s=calcSaving(k);var trips=k==='65'?28:k==='131'?24:32;sc+='‚úÖ Bus '+k+': S$'+(s*trips).toLocaleString()+'/day saved<br>';});
    sc+='<br><strong>Total: S$'+totalSaved.toLocaleString()+'/day</strong>';
    document.getElementById('session-results').style.display='block';
    document.getElementById('session-content').innerHTML=sc;
  }
}

/* ==============================
   DEPLOY ROUTE
============================== */
window.deployRoute=function(k){
  if(doneRoutes[k])return;
  doneRoutes[k]=true;

  var r=ROUTES[k];
  var rd=routeData[k];

  // 1. Remove the dotted incident (blocked) segment ‚Äî no longer needed
  if(rd&&rd.incidentPl){
    rd.incidentPl.remove();
    rd.incidentPl=null;
  }

  // 2. Convert the dotted bypass ‚Üí solid GREEN (active deployed route)
  if(rd&&rd.bypassPl){
    rd.bypassPl.setStyle({
      color:'#16a34a',
      weight:6,
      opacity:1,
      dashArray:null   // solid
    });
    rd.bypassPl.bindPopup(pop(
      '‚úÖ DEPLOYED ‚Äî Bus '+k+' Bypass',
      '<strong style="color:#16a34a">cuOPT Active Bypass</strong><br>'
      +r.altLabel+'<br>'
      +'<span style="color:#16a34a">Solid green = live active route</span><br>'
      +'Saving S$'+calcSaving(k)+'/trip'));
  }

  // 3. Update map hint
  document.getElementById('maphint').textContent=
    'Bus '+k+' ‚úÖ Deployed ‚Äî solid green = active bypass | solid '+r.color+' = normal route sections';

  // 4. Update sidebar button
  var btn=document.getElementById('btn-'+k);
  if(btn){btn.textContent='‚úÖ Deployed';btn.classList.add('done');btn.disabled=true;}

  updateStats();
  toast('Route Deployed ‚úÖ',
    'Bus '+k+' bypass now live ‚Äî solid green on map. Saving S$'+calcSaving(k)+'/trip.',
    'var(--accent2)');
  addAi(
    '‚úÖ <strong>Bus '+k+' bypass is now LIVE!</strong><br><br>'
    +'On the map: the bypass section is now a <strong style="color:#16a34a">solid green line</strong>, connecting directly to the solid <span style="color:'+r.color+'">‚ñ†</span> sections of the route on either side of the incident.<br><br>'
    +'Drivers notified via MDT. Estimated saving: <strong>S$'+calcSaving(k)+'/trip</strong>',
    true
  );
};

/* ==============================
   LEAFLET LOADER
============================== */
(function(){
  var lnk=document.createElement('link');lnk.rel='stylesheet';lnk.href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';document.head.appendChild(lnk);
  var s=document.createElement('script');s.src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
  s.onload=initMap;
  s.onerror=function(){
    var l2=document.createElement('link');l2.rel='stylesheet';l2.href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css';document.head.appendChild(l2);
    var s2=document.createElement('script');s2.src='https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js';s2.onload=initMap;document.head.appendChild(s2);
  };
  document.head.appendChild(s);
})();

/* fetchRoad defined above with loadRouteOnMap */

/* ==============================
   MAP INIT
============================== */
var map,lgAcc,lgTrf,lgWth,lgRdw,lgBuses,lgRoutes,lgCuopt;
var mapLayerState={acc:true,trf:true,wth:true,rdw:true,buses:true};
var routeData={};   // {k: {origPath, altPath, origPl, altPl, busMarkers}}
var rerouteDone={};

function initMap(){
  map=L.map('map',{zoomControl:true,scrollWheelZoom:true}).setView([1.3521,103.8198],12);
  window._map=map;

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'¬© <a href="https://openstreetmap.org/copyright">OpenStreetMap</a> | LTA DataMall | OneMap SLA',
    maxZoom:19,subdomains:['a','b','c']
  }).addTo(map);

  lgAcc=L.layerGroup().addTo(map);
  lgTrf=L.layerGroup().addTo(map);
  lgWth=L.layerGroup().addTo(map);
  lgRdw=L.layerGroup().addTo(map);
  lgBuses=L.layerGroup().addTo(map);
  lgRoutes=L.layerGroup().addTo(map);
  lgCuopt=L.layerGroup().addTo(map);

  // Incident markers per type
  addIncidentMarker(ROUTES['65'].inc,lgAcc);
  addIncidentMarker(ROUTES['131'].inc,lgTrf);
  addIncidentMarker(ROUTES['900'].inc,lgWth);
  // Other roadworks
  addMarker(1.2897,103.8501,'rdw','üöß','Geylang Rd Roadworks','Lane closure ‚Äî Bus 65, 67 (minor)',lgRdw);
  addMarker(1.3294,103.7473,'trf','üî¥','PIE/Bukit Batok','Signal fault ‚Äî Bus 173, 174',lgTrf);
  addMarker(1.3644,103.9543,'wth','‚õàÔ∏è','Tampines Ave 10 Flooding','Flash flood ‚Äî Bus 291, 292',lgWth);
  addMarker(1.2855,103.8565,'rdw','üöß','Marina Bay MRT Works','Lane diversion ‚Äî Bus 10, 30',lgRdw);

  // Load all 3 affected routes via OSRM
  Object.keys(ROUTES).forEach(function(k){loadRouteOnMap(k);});

  setTimeout(function(){toast('Network Alert','Bus 900 delay now +25 min. cuOPT re-route ready.','var(--warning)');},3000);
  setTimeout(function(){toast('ECP Update','Accident partially cleared ‚Äî still 1 lane blocked.','var(--accent)');},28000);
}

function eIcon(emoji,size){
  size=size||28;
  return L.divIcon({html:'<div style="font-size:'+size+'px;line-height:1;filter:drop-shadow(0 1px 3px rgba(0,0,0,.3))">'+emoji+'</div>',iconSize:[size,size],iconAnchor:[size/2,size/2],className:''});
}
function pop(title,body){
  return '<div style="font-family:sans-serif;min-width:160px"><b style="font-size:13px">'+title+'</b><div style="font-size:11px;color:#555;margin-top:4px;line-height:1.6">'+body+'</div></div>';
}
var typeColors={acc:'#dc2626',trf:'#0066cc',wth:'#0ea5e9',rdw:'#d97706'};
function addIncidentMarker(inc,lg){
  var col=typeColors[inc.type]||'#888';
  L.circle([inc.lat,inc.lng],{radius:300,color:col,fillColor:col,fillOpacity:.15,weight:2}).bindPopup(pop(inc.emoji+' Incident',inc.desc)).addTo(lg);
  L.marker([inc.lat,inc.lng],{icon:eIcon(inc.emoji)}).bindPopup(pop(inc.emoji+' Incident',inc.desc)).addTo(lg);
}
function addMarker(lat,lng,type,emoji,title,desc,lg){
  var col=typeColors[type]||'#888';
  L.circle([lat,lng],{radius:200,color:col,fillColor:col,fillOpacity:.12,weight:1.5,dashArray:'4,3'}).bindPopup(pop(emoji+' '+title,desc)).addTo(lg);
  L.marker([lat,lng],{icon:eIcon(emoji,22)}).bindPopup(pop(emoji+' '+title,desc)).addTo(lg);
}

/* ==============================
   OSRM road-following route
============================== */
function fetchRoad(wp,cb){
  // Need at least 2 distinct points
  if(!wp||wp.length<2){cb(wp||[]);return;}
  var coords=wp.map(function(p){return p[1]+','+p[0];}).join(';');
  fetch('https://router.project-osrm.org/route/v1/driving/'+coords+'?overview=full&geometries=geojson')
    .then(function(r){return r.json();})
    .then(function(d){
      if(d.routes&&d.routes[0]){
        cb(d.routes[0].geometry.coordinates.map(function(c){return[c[1],c[0]];}));
      } else {cb(wp);}
    }).catch(function(){cb(wp);});
}

/* Helper: split an OSRM path array into [before, incident, after] portions
   using splitFracStart and splitFracEnd (0..1) along the path */
function splitPath(path, fracStart, fracEnd){
  var n=path.length;
  var iS=Math.max(1, Math.floor(fracStart*n));
  var iE=Math.min(n-1, Math.floor(fracEnd*n));
  if(iS>=iE){ iS=Math.floor(n*0.3); iE=Math.floor(n*0.7); }
  return {
    before:  path.slice(0, iS+1),       // includes the split point
    incident:path.slice(iS, iE+1),      // the blocked segment
    after:   path.slice(iE)             // from end of incident to terminus
  };
}

/* --- Load original route: fetch full OSRM path, draw as one solid coloured line --- */
function loadRouteOnMap(k){
  var r=ROUTES[k];
  fetchRoad(r.wp, function(fullPath){
    routeData[k]={
      fullPath:   fullPath,
      origPl:     null,
      beforePl:   null,
      afterPl:    null,
      incidentPl: null,
      bypassPl:   null,
      busMarkers: [],
      // fractions along fullPath where incident zone starts/ends
      // based on position of splitIdx/splitEndIdx in wp[]
      fracStart: r.splitIdx / (r.wp.length-1),
      fracEnd:   r.splitEndIdx / (r.wp.length-1)
    };
    var pl=L.polyline(fullPath,{color:r.color,weight:5,opacity:.9,smoothFactor:1})
      .bindPopup(pop('üöå '+r.label,
        '<span style="color:'+r.color+'">‚ö† DISRUPTED</span> ¬∑ '+r.buses+' buses ¬∑ +'+r.delay+' min delay<br>'
        +'<small>Click <b>‚ö° cuOPT Re-route</b> to see bypass options</small>'))
      .addTo(lgRoutes);
    routeData[k].origPl=pl;
    spawnBuses(k, fullPath);
  });
}

/* --- Spawn animated buses --- */
function spawnBuses(k,path){
  if(!path||path.length<2)return;
  var r=ROUTES[k];
  for(var i=0;i<r.buses;i++){
    var frac=i/r.buses;
    var idx=Math.floor(frac*path.length);
    var m=L.marker(path[idx],{icon:eIcon('üöå',18),zIndexOffset:100})
      .bindPopup(pop('üöå Bus '+k,'<span style="color:'+r.color+'">‚ö† Delayed +'+r.delay+' min</span>'))
      .addTo(lgBuses);
    routeData[k].busMarkers.push(m);
    startBusAnim(m,path,frac);
  }
}

/* --- Bus animation along path --- */
function startBusAnim(marker,path,startFrac){
  var frac=startFrac||0;
  var speed=0.0025; // fraction/sec
  var last=null;
  function step(ts){
    if(!last)last=ts;
    frac+=speed*(ts-last)/1000;
    if(frac>=1)frac=0;
    last=ts;
    var idx=Math.min(Math.floor(frac*path.length),path.length-1);
    marker.setLatLng(path[idx]);
    marker._raf=requestAnimationFrame(step);
  }
  marker._raf=requestAnimationFrame(step);
  marker._path=path;
  marker._frac=frac;
}

function switchBusPath(k,combinedPath){
  if(!routeData[k]||!combinedPath||combinedPath.length<2) return;
  routeData[k].busMarkers.forEach(function(m){
    if(m._raf) cancelAnimationFrame(m._raf);
    startBusAnim(m, combinedPath, Math.random());
    m.setPopupContent(pop('üöå Bus '+k,
      '<span style="color:#16a34a">‚úÖ Bypass route active ‚Äî on time</span>'));
  });
}

/* ==============================
   MAP LAYER TOGGLE (toolbar)
============================== */
var lgMap={acc:null,trf:null,wth:null,rdw:null,buses:null};
// Assign after init ‚Äî we need to wait for lgAcc etc.
function getLg(name){return {acc:lgAcc,trf:lgTrf,wth:lgWth,rdw:lgRdw,buses:lgBuses}[name];}

window.mapToggle=function(name,btn){
  mapLayerState[name]=!mapLayerState[name];
  var lg=getLg(name);
  if(lg){mapLayerState[name]?lg.addTo(map):lg.remove();}
  btn.classList.toggle('active',mapLayerState[name]);

  // Also sync route visibility: if type toggled off, hide matching route card
  if(name!=='buses'){
    filterState[name]=mapLayerState[name];
    var chip=document.getElementById('fc-'+name);
    if(chip)chip.className='f-chip'+(filterState[name]?' on-'+name:'');
    document.querySelectorAll('.ic[data-type="'+name+'"]').forEach(function(c){c.style.display=filterState[name]?'':'none';});
  }
};

function syncMapLayerFromFilter(type,state){
  mapLayerState[type]=state;
  var btn=document.getElementById('ml-'+type);
  if(btn)btn.classList.toggle('active',state);
  var lg=getLg(type);
  if(lg){state?lg.addTo(map):lg.remove();}
}

/* ==============================
   SELECT INCIDENT
============================== */
window.selInc=function(k,el){
  document.querySelectorAll('.ic').forEach(function(c){c.classList.remove('sel');});
  el.classList.add('sel');
  if(!map)return;
  var r=ROUTES[k];
  var inc=r.inc;
  map.flyTo([inc.lat,inc.lng],14,{duration:1.2});
};

/* ==============================
   REROUTE FLOW
   Uses the already-fetched fullPath and splits it at the incident fractions.
   Only needs ONE new OSRM fetch: the bypass segment.
   States:
     Before reroute:  one solid full-colour line
     After reroute:   solid before + dotted incident (same colour) + solid after + dotted bypass (same colour)
     After deploy:    solid before + solid green bypass + solid after  (incident segment removed)
============================== */
window.doReroute=function(k){
  if(rerouteDone[k]) return;
  var r=ROUTES[k];
  var rd=routeData[k];

  // Select card visually
  var card=document.getElementById('card-'+k);
  if(card){
    document.querySelectorAll('.ic').forEach(function(c){c.classList.remove('sel');});
    card.classList.add('sel');
  }

  // Fly to incident zone
  map.flyTo([r.inc.lat, r.inc.lng], 14, {duration:1});

  // Show computing overlay
  var ov=document.getElementById('cov');
  var st=document.getElementById('covSt');
  var bar=document.getElementById('progBar');
  bar.style.width='0%';
  ov.classList.add('show');

  var steps=[
    'Loading LTA DataMall live traffic feed...',
    'Fetching OneMap SLA road network...',
    'Applying incident exclusion zones...',
    'Building travel-time cost matrix...',
    'GPU parallel solving ‚Äî '+r.solveRoutes.toLocaleString()+' permutations...',
    'Applying headway & capacity constraints...',
    '‚úÖ Optimal bypass route found!'
  ];
  var si=0;
  var iv=setInterval(function(){
    if(si<steps.length){
      st.textContent=steps[si];
      bar.style.width=Math.round((si+1)/steps.length*100)+'%';
      si++;
    } else {
      clearInterval(iv);
      document.getElementById('solveT').textContent=(0.35+Math.random()*0.45).toFixed(2)+'s';

      // Fetch ONLY the bypass segment via OSRM
      fetchRoad(r.bypassWp, function(bypassPath){
        ov.classList.remove('show');
        rerouteDone[k]=true;

        // Split the cached full path into before / incident / after
        var segs=splitPath(rd.fullPath, rd.fracStart, rd.fracEnd);

        // 1. Remove the original solid full line
        if(rd.origPl){ rd.origPl.remove(); rd.origPl=null; }

        // 2. Draw BEFORE segment ‚Äî solid, original colour (route is normal here)
        rd.beforePl=L.polyline(segs.before,{
          color:r.color, weight:5, opacity:.9, smoothFactor:1
        }).bindPopup(pop('üöå Bus '+k+' ‚Äî Normal section','Unaffected portion of route'))
          .addTo(lgRoutes);

        // 3. Draw AFTER segment ‚Äî solid, original colour (route is normal here)
        if(segs.after && segs.after.length>1){
          rd.afterPl=L.polyline(segs.after,{
            color:r.color, weight:5, opacity:.9, smoothFactor:1
          }).bindPopup(pop('üöå Bus '+k+' ‚Äî Normal section','Unaffected portion of route'))
            .addTo(lgRoutes);
        }

        // 4. Draw INCIDENT segment ‚Äî same colour, DOTTED (shows the blocked portion of the route)
        rd.incidentPl=L.polyline(segs.incident,{
          color:r.color, weight:5, opacity:.75, dashArray:'9,7', smoothFactor:1
        }).bindPopup(pop('‚ö† Blocked ‚Äî Bus '+k,
          '<span style="color:'+r.color+'"><b>Dotted = disrupted section</b></span><br>'+r.inc.desc))
          .addTo(lgCuopt);

        // 5. Draw BYPASS segment ‚Äî same colour, DOTTED (proposed detour around incident)
        rd.bypassPl=L.polyline(bypassPath,{
          color:r.color, weight:5, opacity:.95, dashArray:'14,7', smoothFactor:1
        }).bindPopup(pop('‚ö° cuOPT Bypass ‚Äî Bus '+k,
          '<b style="color:'+r.color+'">'+r.altLabel+'</b><br>'
          +'Dotted = proposed, not yet deployed<br>'
          +'Saving <b>S$'+calcSaving(k)+'</b>/trip ¬∑ Click Deploy to activate'))
          .addTo(lgCuopt);

        // Store bypass path for deploy step
        rd.bypassPath=bypassPath;
        rd.incidentSeg=segs.incident;

        // Zoom map to show the incident area + bypass side by side
        var zonePts=segs.incident.concat(bypassPath);
        map.fitBounds(L.latLngBounds(zonePts).pad(0.3), {animate:true, duration:1.2});

        // Migrate buses to travel via bypass instead of incident segment
        var activePath=segs.before.concat(bypassPath).concat(segs.after||[]);
        switchBusPath(k, activePath);

        // Update hints
        document.getElementById('maphint').textContent=
          'Bus '+k+': dotted = blocked section & bypass | same colour | deploy ‚Üí green';
        toast('cuOPT Bypass Ready',
          'Bus '+k+': blocked section and bypass shown as dotted lines. Deploy in chat.',
          '#76b900');

        // Chat message
        var msgEl=addAi(
          '‚úÖ <strong>Bus '+k+' cuOPT bypass computed!</strong><br><br>'
          +'On the map you\'ll see the affected section of the route is now shown as a '
          +'<b style="color:'+r.color+'">dotted line</b> ‚Äî that\'s the blocked road. Alongside it, '
          +'the cuOPT bypass road is also shown as a <b style="color:'+r.color+'">dotted line of the same colour</b>. '
          +'The rest of the route on either side stays as a solid line.<br><br>'
          +'Click <b>Deploy</b> below ‚Äî the bypass dotted line turns '
          +'<b style="color:#16a34a">solid green ‚úÖ</b> and the blocked section is removed:',
          true
        );
        msgEl.querySelector('.bub').insertAdjacentHTML('beforeend', savingsHTML(k));
        scrl();
        updateStats();
      });
    }
  }, 290);
};
</script>
</body>
</html>
