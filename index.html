<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SBST √ó NVIDIA cuOPT ‚Äî Network Command Centre</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#f4f6fa; --surface:#fff; --surface2:#f0f3f8; --border:#dde3ef;
  --accent:#0066cc; --accent-light:#e8f0fb;
  --accent2:#16a34a; --accent2-light:#dcfce7;
  --warning:#d97706; --warning-light:#fef3c7;
  --danger:#dc2626; --danger-light:#fee2e2;
  --text:#0f172a; --text2:#374151; --muted:#6b7280;
  --nvidia:#76b900; --nvidia-light:#f0fce4; --sbst:#e31837;
  --shadow:0 1px 3px rgba(0,0,0,.08); --shadow-md:0 4px 16px rgba(0,0,0,.12);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;height:100vh;display:flex;flex-direction:column;overflow:hidden;}

/* HEADER */
header{display:flex;align-items:center;justify-content:space-between;padding:0 20px;height:54px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;box-shadow:var(--shadow);z-index:200;position:relative;}
.header-left{display:flex;align-items:center;gap:14px;}
.logo-sbst{font-family:'Space Mono',monospace;font-size:15px;font-weight:700;color:var(--sbst);}
.logo-div{width:1px;height:24px;background:var(--border);}
.nvidia-badge{background:var(--nvidia-light);border:1px solid #b6e05a;border-radius:5px;padding:3px 9px;font-family:'Space Mono',monospace;font-size:9px;color:#4a7c00;letter-spacing:1px;font-weight:700;}
.header-center{position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:8px;font-family:'Space Mono',monospace;font-size:11px;color:var(--muted);}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--accent2);box-shadow:0 0 0 2px var(--accent2-light);animation:blink 2s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
.header-right{display:flex;align-items:center;gap:20px;}
.time-display{font-family:'Space Mono',monospace;font-size:17px;color:var(--accent);letter-spacing:2px;font-weight:700;}
.kpi-mini{display:flex;gap:18px;}
.kpi-item{text-align:center;}
.kpi-val{font-size:15px;font-weight:700;}
.kpi-lbl{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;}

/* LAYOUT */
.main{display:grid;grid-template-columns:272px 1fr 320px;flex:1;overflow:hidden;}

/* LEFT */
.left-panel{background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
.section-tabs{display:flex;border-bottom:1px solid var(--border);background:var(--surface2);}
.tab-btn{flex:1;padding:9px 4px;background:none;border:none;border-bottom:2px solid transparent;color:var(--muted);font-size:10px;cursor:pointer;font-family:'Space Mono',monospace;letter-spacing:.5px;transition:all .2s;}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent);background:var(--surface);}
.panel-hdr{padding:10px 16px;border-bottom:1px solid var(--border);font-family:'Space Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;display:flex;align-items:center;justify-content:space-between;background:var(--surface2);}
.badge{background:var(--warning);color:#fff;border-radius:10px;padding:1px 7px;font-size:9px;font-weight:700;}
.scroll{flex:1;overflow-y:auto;}
.scroll::-webkit-scrollbar{width:4px;}
.scroll::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

/* Incident cards */
.inc-card{padding:11px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;border-left:3px solid transparent;}
.inc-card:hover{background:var(--surface2);}
.inc-card.sel{background:var(--accent-light);border-left-color:var(--accent);}
.inc-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;}
.inc-type{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;padding:2px 7px;border-radius:3px;}
.t-acc{background:var(--danger-light);color:var(--danger);}
.t-rdw{background:var(--warning-light);color:var(--warning);}
.t-trf{background:var(--accent-light);color:var(--accent);}
.t-wth{background:#e0f2fe;color:#0369a1;}
.inc-time{font-size:9px;color:var(--muted);font-family:'Space Mono',monospace;}
.inc-desc{font-size:12px;color:var(--text2);line-height:1.4;}
.inc-aff{font-size:10px;color:var(--muted);margin-top:3px;}
.inc-aff strong{color:var(--warning);}
.reroute-btn{margin-top:7px;padding:5px 10px;background:var(--nvidia);border:none;border-radius:5px;color:#fff;font-size:10px;font-weight:700;cursor:pointer;font-family:'Space Mono',monospace;letter-spacing:.5px;transition:all .2s;}
.reroute-btn:hover{background:#5a9900;}
.reroute-btn.done{background:var(--accent2);}

/* CENTER */
.center-panel{display:flex;flex-direction:column;overflow:hidden;position:relative;}
.map-toolbar{display:flex;align-items:center;gap:6px;flex-wrap:wrap;padding:8px 12px;background:var(--surface);border-bottom:1px solid var(--border);}
.map-btn{padding:5px 11px;border-radius:5px;border:1px solid var(--border);background:var(--surface2);color:var(--muted);font-size:10px;cursor:pointer;font-family:'Space Mono',monospace;transition:all .2s;display:flex;align-items:center;gap:5px;}
.map-btn.active{border-color:var(--accent);color:var(--accent);background:var(--accent-light);}
.map-btn:hover:not(.active){border-color:#aaa;color:var(--text);}
.dot-ind{width:6px;height:6px;border-radius:50%;}
#map{flex:1;min-height:0;}
.map-legend{position:absolute;bottom:14px;left:14px;background:rgba(255,255,255,.97);border:1px solid var(--border);border-radius:8px;padding:12px 14px;z-index:500;box-shadow:var(--shadow-md);}
.leg-title{font-family:'Space Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:1px;margin-bottom:8px;text-transform:uppercase;}
.leg-item{display:flex;align-items:center;gap:8px;margin-bottom:5px;font-size:11px;color:var(--text2);}
.leg-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.leg-line{width:22px;height:3px;border-radius:2px;flex-shrink:0;}

/* Computing overlay */
.compute-ov{position:absolute;inset:0;background:rgba(255,255,255,.95);z-index:400;display:none;align-items:center;justify-content:center;flex-direction:column;gap:14px;backdrop-filter:blur(4px);}
.compute-ov.show{display:flex;}
.prog-outer{width:300px;height:5px;background:var(--border);border-radius:3px;overflow:hidden;}
.prog-inner{height:100%;background:linear-gradient(90deg,var(--nvidia),var(--accent));border-radius:3px;width:0%;transition:width .3s;}

/* Savings Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(15,23,42,.5);z-index:800;display:none;align-items:center;justify-content:center;}
.modal-overlay.show{display:flex;}
.modal{background:var(--surface);border-radius:12px;padding:28px;max-width:520px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.2);position:relative;}
.modal-close{position:absolute;top:14px;right:16px;background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);}
.modal-title{font-size:17px;font-weight:700;margin-bottom:4px;}
.modal-subtitle{font-size:11px;color:var(--muted);margin-bottom:20px;}
.savings-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px;}
.savings-card{border-radius:8px;padding:12px 14px;border:1px solid var(--border);}
.savings-card .sc-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;}
.savings-card .sc-before{font-size:12px;color:var(--danger);text-decoration:line-through;}
.savings-card .sc-after{font-size:18px;font-weight:700;}
.savings-card .sc-save{font-size:11px;margin-top:4px;}
.formula-box{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:16px;font-size:12px;line-height:1.7;color:var(--text2);}
.formula-box strong{color:var(--text);}
.formula-box .formula-line{font-family:'Space Mono',monospace;font-size:11px;color:var(--accent);margin:4px 0;}
.total-saving{background:var(--nvidia-light);border:1px solid #b6e05a;border-radius:8px;padding:14px;text-align:center;}
.total-saving .ts-val{font-size:28px;font-weight:700;color:#4a7c00;font-family:'Space Mono',monospace;}
.total-saving .ts-label{font-size:11px;color:#5a7c00;margin-top:4px;}
.deploy-btn{width:100%;margin-top:14px;padding:12px;background:var(--nvidia);border:none;border-radius:7px;color:#fff;font-weight:700;font-family:'Space Mono',monospace;font-size:11px;cursor:pointer;letter-spacing:1px;}
.deploy-btn:hover{background:#5a9900;}

/* RIGHT CHAT */
.right-panel{background:var(--surface);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
.chat-hdr{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;background:var(--surface2);}
.ai-avatar{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,#76b900,#0066cc);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.chat-title{font-weight:700;font-size:13px;}
.chat-sub{font-size:10px;color:var(--muted);}
.chat-online{margin-left:auto;display:flex;align-items:center;gap:5px;font-size:10px;color:var(--accent2);font-weight:600;}
.chat-msgs{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:12px;}
.chat-msgs::-webkit-scrollbar{width:4px;}
.chat-msgs::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.msg{display:flex;gap:8px;align-items:flex-start;}
.msg.user{flex-direction:row-reverse;}
.msg-av{width:26px;height:26px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;margin-top:2px;}
.msg-av.ai{background:linear-gradient(135deg,#76b900,#0066cc);}
.msg-av.user{background:var(--surface2);border:1px solid var(--border);}
.msg-bub{max-width:240px;padding:9px 12px;border-radius:10px;font-size:12px;line-height:1.55;}
.msg.ai .msg-bub{background:var(--surface2);border:1px solid var(--border);border-top-left-radius:3px;}
.msg.user .msg-bub{background:var(--accent);color:#fff;border-top-right-radius:3px;}
.msg-time{font-size:9px;color:var(--muted);margin-top:3px;font-family:'Space Mono',monospace;}
.msg.user .msg-time{text-align:right;}
.chip{display:inline-block;background:var(--nvidia-light);border:1px solid #b6e05a;border-radius:12px;padding:3px 10px;font-size:10px;color:#4a7c00;margin:3px 3px 0 0;cursor:pointer;}
.chip:hover{background:#d4f0a0;}
.quick-acts{padding:8px 14px;border-top:1px solid var(--border);display:flex;flex-wrap:wrap;gap:5px;background:var(--surface2);}
.qbtn{font-size:10px;padding:4px 10px;background:var(--surface);border:1px solid var(--border);border-radius:12px;color:var(--muted);cursor:pointer;transition:all .2s;}
.qbtn:hover{border-color:var(--accent);color:var(--accent);}
.chat-input-area{padding:12px 14px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:center;}
.chat-input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:8px 12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:12px;outline:none;height:38px;transition:border-color .2s;}
.chat-input:focus{border-color:var(--accent);}
.chat-input::placeholder{color:var(--muted);}
.send-btn{width:38px;height:38px;border-radius:7px;background:var(--accent);border:none;color:#fff;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;}
.send-btn:hover{background:#0052a3;}
.typing{display:flex;gap:4px;align-items:center;}
.typing span{width:6px;height:6px;background:var(--muted);border-radius:50%;animation:bounce 1.2s infinite;}
.typing span:nth-child(2){animation-delay:.2s;}
.typing span:nth-child(3){animation-delay:.4s;}
@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}

/* STATS BAR */
.stats-bar{display:flex;align-items:center;height:36px;background:var(--surface);border-top:1px solid var(--border);flex-shrink:0;padding:0 16px;overflow:hidden;}
.stat-item{display:flex;align-items:center;gap:8px;padding:0 14px;border-right:1px solid var(--border);white-space:nowrap;}
.stat-item:first-child{padding-left:0;}
.stat-lbl{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;}
.stat-val{font-family:'Space Mono',monospace;font-size:12px;font-weight:700;}

/* TOAST */
.toast{position:fixed;top:62px;right:330px;background:var(--surface);border:1px solid var(--border);border-left:4px solid var(--warning);border-radius:8px;padding:10px 14px;z-index:1000;box-shadow:var(--shadow-md);font-size:12px;max-width:260px;transform:translateY(-8px);opacity:0;transition:all .3s;pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}
.toast-title{font-weight:700;margin-bottom:3px;color:var(--warning);font-size:11px;}
.toast-msg{color:var(--text2);line-height:1.4;}

/* Route status tag on map */
.route-status-tag{background:#fff;border:1px solid var(--border);border-radius:4px;padding:2px 6px;font-size:10px;font-weight:600;}
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="header-left">
    <div class="logo-sbst">SBS Transit</div>
    <div class="logo-div"></div>
    <div class="nvidia-badge">‚ö° NVIDIA cuOPT‚Ñ¢</div>
  </div>
  <div class="header-center">
    <div class="live-dot"></div>
    <span>NETWORK COMMAND CENTRE ‚Äî LIVE</span>
  </div>
  <div class="header-right">
    <div class="kpi-mini">
      <div class="kpi-item"><div class="kpi-val" style="color:var(--accent)">412</div><div class="kpi-lbl">Buses Live</div></div>
      <div class="kpi-item"><div class="kpi-val" style="color:var(--danger)">3</div><div class="kpi-lbl">Need Reroute</div></div>
      <div class="kpi-item"><div class="kpi-val" style="color:#4a7c00" id="optSaving">‚Äî</div><div class="kpi-lbl">cuOPT Saved</div></div>
    </div>
    <div class="time-display" id="clock">--:--:--</div>
  </div>
</header>

<!-- MAIN -->
<div class="main">

  <!-- LEFT PANEL -->
  <div class="left-panel">
    <div class="section-tabs">
      <button class="tab-btn active" onclick="switchTab('incidents')">DISRUPTIONS</button>
      <button class="tab-btn" onclick="switchTab('cuopt')">cuOPT STATUS</button>
    </div>

    <!-- DISRUPTIONS TAB -->
    <div id="tab-incidents" class="scroll">
      <div class="panel-hdr">Routes Needing Re-optimisation <span class="badge">3</span></div>

      <!-- Route A -->
      <div class="inc-card sel" id="card-65" onclick="selectIncident('65',this)">
        <div class="inc-head"><span class="inc-type t-acc">ACCIDENT</span><span class="inc-time">08:23</span></div>
        <div class="inc-desc">ECP near Bedok Interchange ‚Äî 3-vehicle collision, 2 lanes blocked</div>
        <div class="inc-aff">Route affected: <strong>Bus 65</strong> ¬∑ Current delay: <strong style="color:var(--danger)">+18 min</strong></div>
        <button class="reroute-btn" id="btn-65" onclick="event.stopPropagation();requestReroute('65')">‚ö° Request cuOPT Re-route</button>
      </div>

      <!-- Route B -->
      <div class="inc-card" id="card-131" onclick="selectIncident('131',this)">
        <div class="inc-head"><span class="inc-type t-trf">CONGESTION</span><span class="inc-time">07:45</span></div>
        <div class="inc-desc">CTE northbound ‚Äî severe congestion, 6km queue from Braddell to PIE</div>
        <div class="inc-aff">Route affected: <strong>Bus 131</strong> ¬∑ Current delay: <strong style="color:var(--danger)">+22 min</strong></div>
        <button class="reroute-btn" id="btn-131" onclick="event.stopPropagation();requestReroute('131')">‚ö° Request cuOPT Re-route</button>
      </div>

      <!-- Route C -->
      <div class="inc-card" id="card-900" onclick="selectIncident('900',this)">
        <div class="inc-head"><span class="inc-type t-wth">HEAVY RAIN</span><span class="inc-time">08:10</span></div>
        <div class="inc-desc">Flash flooding at Woodlands Ave 12 ‚Äî road partially submerged</div>
        <div class="inc-aff">Route affected: <strong>Bus 900</strong> ¬∑ Current delay: <strong style="color:var(--danger)">+25 min</strong></div>
        <button class="reroute-btn" id="btn-900" onclick="event.stopPropagation();requestReroute('900')">‚ö° Request cuOPT Re-route</button>
      </div>

      <div style="padding:14px;background:var(--surface2);border-bottom:1px solid var(--border);">
        <div style="font-size:10px;color:var(--muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:.8px">Other Active Incidents</div>
        <div style="font-size:11px;color:var(--text2);line-height:1.9">
          üöß Geylang Rd roadworks ‚Äî Bus 65, 67 (minor)<br>
          üî¥ PIE/Bukit Batok signal fault ‚Äî Bus 173, 174<br>
          ‚õàÔ∏è Tampines Ave 10 flooding ‚Äî Bus 291, 292<br>
          üöß Marina Bay MRT works ‚Äî Bus 10, 30
        </div>
      </div>
    </div>

    <!-- cuOPT STATUS TAB -->
    <div id="tab-cuopt" class="scroll" style="display:none">
      <div class="panel-hdr">NVIDIA cuOPT Engine</div>
      <div style="padding:14px">
        <div style="background:var(--nvidia-light);border:1px solid #b6e05a;border-radius:8px;padding:12px;margin-bottom:14px">
          <div style="font-family:'Space Mono',monospace;font-size:9px;color:#4a7c00;letter-spacing:1px;margin-bottom:6px">‚ö° GPU-ACCELERATED VRP SOLVER</div>
          <div style="font-size:11px;color:var(--text2);line-height:1.65">cuOPT uses NVIDIA GPU parallel computing to solve Vehicle Routing Problems in <strong>under 1 second</strong>, versus hours on CPU-based solvers.</div>
        </div>
        <div style="margin-bottom:14px">
          <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px">Live System Status</div>
          <div style="display:flex;flex-direction:column;gap:6px;font-size:11px">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <span>GPU Cluster (8√ó A100)</span><span style="color:var(--accent2);font-weight:600">‚óè Online</span>
            </div>
            <div style="display:flex;align-items:center;justify-content:space-between">
              <span>Fleet telemetry feed</span><span style="color:var(--accent2);font-weight:600">‚óè Live</span>
            </div>
            <div style="display:flex;align-items:center;justify-content:space-between">
              <span>LTA DataMall API</span><span style="color:var(--accent2);font-weight:600">‚óè Synced</span>
            </div>
            <div style="display:flex;align-items:center;justify-content:space-between">
              <span>OneMap SLA routing</span><span style="color:var(--accent2);font-weight:600">‚óè Active</span>
            </div>
          </div>
        </div>
        <div id="cuopt-run-summary" style="display:none;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:14px">
          <div style="font-family:'Space Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:1px;margin-bottom:8px">SESSION RESULTS</div>
          <div id="run-summary-content" style="font-size:11px;color:var(--text2);line-height:1.8"></div>
        </div>
        <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px">How cuOPT Saves Cost</div>
        <div style="font-size:11px;color:var(--text2);line-height:1.8;margin-bottom:14px">
          ‚úÖ Finds shortest viable alternate road path<br>
          ‚úÖ Minimises deadhead (empty) kilometres<br>
          ‚úÖ Balances driver overtime costs<br>
          ‚úÖ Reduces passenger compensation claims<br>
          ‚úÖ Optimises fuel burn on new route<br>
          ‚úÖ Reschedules stop dwell times
        </div>
        <div style="font-size:9px;color:var(--muted);line-height:1.7;border-top:1px solid var(--border);padding-top:10px">
          Click <strong>‚ö° Request cuOPT Re-route</strong> on any disrupted route to compute an optimised alternate path and view full savings breakdown.
        </div>
      </div>
    </div>
  </div>

  <!-- CENTER MAP -->
  <div class="center-panel">
    <div class="map-toolbar">
      <button class="map-btn active" id="btn-layer-incidents" onclick="toggleLayer('incidents',this)"><span class="dot-ind" style="background:var(--danger)"></span>Incidents</button>
      <button class="map-btn active" id="btn-layer-buses" onclick="toggleLayer('buses',this)"><span class="dot-ind" style="background:var(--accent2)"></span>Live Buses</button>
      <button class="map-btn active" id="btn-layer-routes" onclick="toggleLayer('routes',this)"><span class="dot-ind" style="background:var(--accent)"></span>Affected Routes</button>
      <div style="margin-left:auto;font-size:10px;color:var(--muted);font-family:'Space Mono',monospace" id="map-status">Click a disruption ‚Üí Request Re-route</div>
    </div>

    <div id="map"></div>

    <div class="map-legend">
      <div class="leg-title">Map Legend</div>
      <div class="leg-item"><div class="leg-dot" style="background:var(--danger)"></div>Accident / Incident</div>
      <div class="leg-item"><div class="leg-dot" style="background:#0ea5e9"></div>Weather / Flooding</div>
      <div class="leg-item"><div class="leg-line" style="background:var(--danger)"></div>Affected Bus Route</div>
      <div class="leg-item">
        <div style="width:22px;height:0;border-top:3px dashed #76b900;flex-shrink:0"></div>
        cuOPT Re-route
      </div>
      <div class="leg-item"><span style="font-size:13px">üöå</span>Live Bus (GPS)</div>
    </div>

    <div class="compute-ov" id="computeOv">
      <div style="font-size:42px">‚ö°</div>
      <div style="font-family:'Space Mono',monospace;font-size:16px;color:#4a7c00;letter-spacing:2px">cuOPT COMPUTING</div>
      <div style="font-size:12px;color:var(--muted)" id="computeSt">Initialising...</div>
      <div class="prog-outer"><div class="prog-inner" id="progBar"></div></div>
    </div>
  </div>

  <!-- RIGHT CHAT -->
  <div class="right-panel">
    <div class="chat-hdr">
      <div class="ai-avatar">ü§ñ</div>
      <div>
        <div class="chat-title">SBST AI Operator</div>
        <div class="chat-sub">cuOPT + LTA DataMall + OneMap</div>
      </div>
      <div class="chat-online"><div class="live-dot"></div>Online</div>
    </div>
    <div class="chat-msgs" id="chatMsgs">
      <div class="msg ai">
        <div class="msg-av ai">ü§ñ</div>
        <div>
          <div class="msg-bub">
            Good morning! I'm monitoring <strong>412 buses</strong> across the SBST network.<br><br>
            I've identified <strong>3 routes</strong> that need re-optimisation due to active disruptions ‚Äî Bus 65 (accident), Bus 131 (congestion) and Bus 900 (flooding).<br><br>
            Their current routes are shown on the map in <strong style="color:var(--danger)">red</strong>. Request a re-route on any of them to see cuOPT's optimised alternate path.
            <div style="margin-top:8px">
              <span class="chip" onclick="sendQ('Reroute Bus 65 around the ECP accident')">Reroute Bus 65</span>
              <span class="chip" onclick="sendQ('Reroute Bus 131 around CTE congestion')">Reroute Bus 131</span>
              <span class="chip" onclick="sendQ('Reroute Bus 900 around Woodlands flood')">Reroute Bus 900</span>
            </div>
          </div>
          <div class="msg-time">08:31:02</div>
        </div>
      </div>
    </div>
    <div class="quick-acts">
      <button class="qbtn" onclick="sendQ('How is the savings calculated for re-routing?')">How savings work?</button>
      <button class="qbtn" onclick="sendQ('Which route has the worst delay right now?')">Worst delay?</button>
      <button class="qbtn" onclick="sendQ('What is the total saving if I reroute all 3?')">Total savings?</button>
      <button class="qbtn" onclick="sendQ('Reroute Bus 900 around Woodlands flood')">Reroute 900</button>
    </div>
    <div class="chat-input-area">
      <input class="chat-input" id="chatInput" placeholder="Ask about routes, savings, re-routing..." onkeydown="if(event.key==='Enter')sendMessage()">
      <button class="send-btn" onclick="sendMessage()">‚û§</button>
    </div>
  </div>
</div>

<!-- STATS BAR -->
<div class="stats-bar">
  <div class="stat-item"><span class="stat-lbl">Buses Active</span><span class="stat-val" style="color:var(--accent)">412 / 450</span></div>
  <div class="stat-item"><span class="stat-lbl">Routes Disrupted</span><span class="stat-val" style="color:var(--danger)">3</span></div>
  <div class="stat-item"><span class="stat-lbl">Reroutes Done</span><span class="stat-val" style="color:#4a7c00" id="rerouteCount">0 / 3</span></div>
  <div class="stat-item"><span class="stat-lbl">Total Savings</span><span class="stat-val" style="color:var(--accent2)" id="totalSavings">S$0</span></div>
  <div class="stat-item"><span class="stat-lbl">Avg Delay Saved</span><span class="stat-val" style="color:var(--warning)" id="avgDelay">‚Äî min</span></div>
  <div class="stat-item"><span class="stat-lbl">cuOPT Solve Time</span><span class="stat-val" style="color:#4a7c00" id="solveTime">‚Äî</span></div>
  <div class="stat-item"><span class="stat-lbl">Pax Benefitting</span><span class="stat-val" style="color:var(--accent)" id="paxBenefit">‚Äî</span></div>
</div>

<!-- SAVINGS MODAL -->
<div class="modal-overlay" id="savingsModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div class="modal-title" id="modal-title">cuOPT Savings Breakdown</div>
    <div class="modal-subtitle" id="modal-subtitle">Powered by NVIDIA GPU-accelerated Vehicle Routing</div>

    <div class="savings-grid" id="savings-grid"></div>

    <div class="formula-box" id="formula-box"></div>

    <div class="total-saving">
      <div class="ts-val" id="ts-val">S$0</div>
      <div class="ts-label" id="ts-label">Projected saving per trip on this route</div>
    </div>
    <button class="deploy-btn" id="deploy-btn" onclick="deployRoute()">‚úÖ DEPLOY THIS RE-ROUTE NOW</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"><div class="toast-title" id="toastTitle"></div><div class="toast-msg" id="toastMsg"></div></div>

<script>
/* =====================================================
   CLOCK
===================================================== */
function updateClock(){
  document.getElementById('clock').textContent=new Date().toLocaleTimeString('en-SG',{hour12:false});
}
setInterval(updateClock,1000); updateClock();

/* =====================================================
   TAB
===================================================== */
window.switchTab=function(tab){
  document.getElementById('tab-incidents').style.display=tab==='incidents'?'block':'none';
  document.getElementById('tab-cuopt').style.display=tab==='cuopt'?'block':'none';
  document.querySelectorAll('.tab-btn').forEach(function(b,i){b.classList.toggle('active',['incidents','cuopt'][i]===tab);});
};

/* =====================================================
   TOAST
===================================================== */
function showToast(title,msg,color){
  var t=document.getElementById('toast');
  document.getElementById('toastTitle').textContent=title;
  document.getElementById('toastMsg').textContent=msg;
  t.style.borderLeftColor=color||'var(--warning)';
  t.classList.add('show');
  clearTimeout(t._timer);
  t._timer=setTimeout(function(){t.classList.remove('show');},5000);
}

/* =====================================================
   CHAT
===================================================== */
function gt(){return new Date().toLocaleTimeString('en-SG',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});}
function fmt(s){return s.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');}
function addUser(t){
  document.getElementById('chatMsgs').insertAdjacentHTML('beforeend',
    '<div class="msg user"><div class="msg-av user">üë§</div><div><div class="msg-bub">'+t.replace(/</g,'&lt;')+'</div><div class="msg-time">'+gt()+'</div></div></div>');
  scrl();
}
function addAi(t){
  document.getElementById('chatMsgs').insertAdjacentHTML('beforeend',
    '<div class="msg ai"><div class="msg-av ai">ü§ñ</div><div><div class="msg-bub">'+fmt(t)+'</div><div class="msg-time">'+gt()+'</div></div></div>');
  scrl();
}
function addTyping(){
  var id='ty'+Date.now();
  document.getElementById('chatMsgs').insertAdjacentHTML('beforeend',
    '<div class="msg ai" id="'+id+'"><div class="msg-av ai">ü§ñ</div><div class="msg-bub"><div class="typing"><span></span><span></span><span></span></div></div></div>');
  scrl(); return id;
}
function scrl(){var c=document.getElementById('chatMsgs');c.scrollTop=c.scrollHeight;}

var SAVINGS={
  '65':{delay:18,pax:1240,kmSaved:3.2,fuelSave:18.40,overtimeSave:0,penaltySave:186,totalPerTrip:246,tripsPerDay:28,route:'Bus 65 (ECP ‚Üí Bedok)'},
  '131':{delay:22,pax:980,kmSaved:4.1,fuelSave:23.60,overtimeSave:45,penaltySave:226,totalPerTrip:318,tripsPerDay:24,route:'Bus 131 (CTE ‚Üí Bishan)'},
  '900':{delay:25,pax:1450,kmSaved:2.8,fuelSave:16.10,overtimeSave:68,penaltySave:290,totalPerTrip:402,tripsPerDay:32,route:'Bus 900 (Woodlands ‚Üí City)'}
};

var RESP={
  savings:'**How cuOPT savings are calculated:**\n\nWhen a route is disrupted, every minute of delay has a real cost:\n\n**1. Delay Penalty Cost**\nSBST pays LTA performance penalties for buses >5 min late. Each min late = ~S$8‚Äì12 penalty per trip.\n\n**2. Fuel Cost**\nIdle buses in jams burn fuel unproductively. Shorter re-routes reduce this directly.\n\n**3. Driver Overtime**\nExtended delays push drivers into overtime shifts (+S$18‚Äì25/hr surcharge).\n\n**4. Passenger Compensation**\nSevere delays (>20 min) trigger passenger goodwill vouchers (~S$0.20/pax).\n\ncuOPT minimises the **sum of all these costs** across all constraints simultaneously on GPU ‚Äî finding the optimal route in under 1 second.',
  worst:'**Bus 900 has the worst delay** at +25 min, affecting ~1,450 passengers due to Woodlands flooding.\n\nBus 131 (+22 min, CTE congestion) is second, and Bus 65 (+18 min, ECP accident) third.\n\nClick **‚ö° Request cuOPT Re-route** on any card to compute the optimal alternate path and see the full savings breakdown.',
  total:'**If all 3 routes are re-routed by cuOPT:**\n\n‚Ä¢ Bus 65 saves ~**S$246/trip √ó 28 trips = S$6,888/day**\n‚Ä¢ Bus 131 saves ~**S$318/trip √ó 24 trips = S$7,632/day**\n‚Ä¢ Bus 900 saves ~**S$402/trip √ó 32 trips = S$12,864/day**\n\n**Total daily saving: S$27,384**\nAnnualised (if recurring incidents): ~S$2.1M/year\n\ncuOPT solved all 3 routes simultaneously in **0.83 seconds** on GPU.',
  reroute65:'Computing cuOPT re-route for **Bus 65** around the ECP accident...',
  reroute131:'Computing cuOPT re-route for **Bus 131** around the CTE congestion...',
  reroute900:'Computing cuOPT re-route for **Bus 900** around the Woodlands flooding...',
  def:'Based on live network data, I\'m tracking **3 routes needing re-optimisation**.\n\nUse the **‚ö° Request cuOPT Re-route** buttons to compute GPU-optimised alternate paths, or ask me about savings calculations, delays, or deployment.'
};

function getResp(msg){
  var m=msg.toLowerCase();
  if(m.includes('saving')||m.includes('calculat')||m.includes('how')) return RESP.savings;
  if(m.includes('worst')||m.includes('delay')) return RESP.worst;
  if(m.includes('total')||m.includes('all 3')||m.includes('all three')) return RESP.total;
  if(m.includes('65')) { setTimeout(function(){requestReroute('65');},800); return RESP.reroute65; }
  if(m.includes('131')) { setTimeout(function(){requestReroute('131');},800); return RESP.reroute131; }
  if(m.includes('900')) { setTimeout(function(){requestReroute('900');},800); return RESP.reroute900; }
  return RESP.def;
}

window.sendMessage=function(){
  var inp=document.getElementById('chatInput');
  var text=inp.value.trim(); if(!text) return;
  inp.value=''; addUser(text);
  var tid=addTyping();
  setTimeout(function(){
    document.getElementById(tid)&&document.getElementById(tid).remove();
    addAi(getResp(text));
  },900+Math.random()*400);
};
window.sendQ=function(t){document.getElementById('chatInput').value=t;sendMessage();};

/* =====================================================
   SAVINGS MODAL
===================================================== */
var pendingRoute=null;
function showSavingsModal(routeNum){
  var s=SAVINGS[routeNum];
  document.getElementById('modal-title').textContent='cuOPT Savings ‚Äî '+s.route;
  document.getElementById('modal-subtitle').textContent='GPU solve time: 0.'+Math.floor(Math.random()*5+4)+'s on NVIDIA A100 ¬∑ Solve method: Vehicle Routing Problem (VRP)';

  var dailyTotal=s.totalPerTrip*s.tripsPerDay;

  document.getElementById('savings-grid').innerHTML=
    card('Delay Reduction','Current: +'+s.delay+' min','After: &lt;3 min','<span style="color:var(--accent2)">‚àí'+(s.delay-3)+' min saved</span>','var(--accent-light)','#93c5fd')+
    card('Fuel Cost','Idling in jam: ~S$'+(s.fuelSave*1.8).toFixed(0)+'/trip','Rerouted burn: S$'+(s.fuelSave*0.5).toFixed(0)+'/trip','<span style="color:var(--accent2)">S$'+s.fuelSave.toFixed(2)+' saved</span>','#f0fdf4','#86efac')+
    card('LTA Delay Penalty','S$'+(s.delay*9)+' per delayed trip','S$0 (on time)','<span style="color:var(--accent2)">S$'+(s.delay*9)+' saved</span>','var(--warning-light)','#fcd34d')+
    card('Pax Compensation',s.delay>20?'S$'+(s.pax*0.20).toFixed(0)+' vouchers/trip':'S$0 (under 20 min)','S$0 after reroute','<span style="color:var(--accent2)">S$'+s.penaltySave.toFixed(0)+' saved</span>','var(--danger-light)','#fca5a5');

  document.getElementById('formula-box').innerHTML=
    '<strong>üí° How cuOPT calculates this saving:</strong><br><br>'
    +'cuOPT minimises the total cost function across all constraints simultaneously:<br><br>'
    +'<div class="formula-line">Cost = Œ£(delay_penalty √ó late_mins) + fuel_cost(route_km) + overtime_cost + pax_compensation</div>'
    +'<br>For this re-route, cuOPT evaluated <strong>'+(Math.floor(Math.random()*8000+4000)).toLocaleString()+' route permutations</strong> in parallel on GPU and selected the path that minimises total cost while satisfying:<br><br>'
    +'‚Ä¢ Driver break constraints (max 2.5 hr continuous)<br>'
    +'‚Ä¢ Bus capacity at each stop (max 87 pax)<br>'
    +'‚Ä¢ Headway spacing (min 8 min between buses)<br>'
    +'‚Ä¢ Road network turn restrictions (OneMap SLA data)<br>'
    +'‚Ä¢ Flood/accident zone exclusions (LTA DataMall live feed)';

  document.getElementById('ts-val').textContent='S$'+s.totalPerTrip.toLocaleString()+'/trip ¬∑ S$'+dailyTotal.toLocaleString()+'/day';
  document.getElementById('ts-label').textContent=s.tripsPerDay+' trips/day on this route ¬∑ '+s.pax.toLocaleString()+' passengers benefitting';
  pendingRoute=routeNum;
  document.getElementById('savingsModal').classList.add('show');
}

function card(title,before,after,saving,bg,border){
  return '<div class="savings-card" style="background:'+bg+';border-color:'+border+'">'
    +'<div class="sc-label">'+title+'</div>'
    +'<div class="sc-before">'+before+'</div>'
    +'<div class="sc-after">'+after+'</div>'
    +'<div class="sc-save">'+saving+'</div>'
    +'</div>';
}

window.closeModal=function(){document.getElementById('savingsModal').classList.remove('show');};

window.deployRoute=function(){
  closeModal();
  if(!pendingRoute) return;
  var s=SAVINGS[pendingRoute];
  var btn=document.getElementById('btn-'+pendingRoute);
  if(btn){btn.textContent='‚úÖ Re-route Deployed';btn.classList.add('done');btn.disabled=true;}
  rerouteDone[pendingRoute]=true;
  updateStats();
  showToast('Route Deployed ‚úÖ','Bus '+pendingRoute+' re-route is now active. Saving S$'+s.totalPerTrip+'/trip.','var(--accent2)');
  addAi('‚úÖ **Bus '+pendingRoute+' re-route deployed!**\n\nDrivers notified via MDT. Estimated saving: **S$'+s.totalPerTrip+'/trip √ó '+s.tripsPerDay+' trips = S$'+(s.totalPerTrip*s.tripsPerDay).toLocaleString()+'/day**.\n\nThe dashed green line on the map shows the active cuOPT route.');
};

var rerouted=0;
var rerouteDone={};
var totalSaved=0;
var delaysSaved=[];
var paxHelped=0;

function updateStats(){
  rerouted=Object.keys(rerouteDone).length;
  totalSaved=0; delaysSaved=[]; paxHelped=0;
  Object.keys(rerouteDone).forEach(function(k){
    var s=SAVINGS[k];
    totalSaved+=s.totalPerTrip*s.tripsPerDay;
    delaysSaved.push(s.delay-3);
    paxHelped+=s.pax;
  });
  document.getElementById('rerouteCount').textContent=rerouted+' / 3';
  document.getElementById('totalSavings').textContent='S$'+totalSaved.toLocaleString();
  document.getElementById('optSaving').textContent=rerouted>0?'S$'+totalSaved.toLocaleString():'‚Äî';
  document.getElementById('avgDelay').textContent=delaysSaved.length>0?Math.round(delaysSaved.reduce(function(a,b){return a+b;},0)/delaysSaved.length)+' min':'‚Äî min';
  document.getElementById('paxBenefit').textContent=paxHelped>0?paxHelped.toLocaleString()+' pax':'‚Äî';

  // Update cuopt panel
  if(rerouted>0){
    var summary='';
    Object.keys(rerouteDone).forEach(function(k){
      var s=SAVINGS[k];
      summary+='‚úÖ Bus '+k+': S$'+(s.totalPerTrip*s.tripsPerDay).toLocaleString()+'/day saved<br>';
    });
    document.getElementById('cuopt-run-summary').style.display='block';
    document.getElementById('run-summary-content').innerHTML=summary+'<br><strong>Total: S$'+totalSaved.toLocaleString()+'/day</strong>';
  }
}

/* =====================================================
   LEAFLET + MAP
===================================================== */
(function(){
  var lnk=document.createElement('link');
  lnk.rel='stylesheet';
  lnk.href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
  document.head.appendChild(lnk);
  var s=document.createElement('script');
  s.src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
  s.onload=initMap;
  s.onerror=function(){
    var l2=document.createElement('link');l2.rel='stylesheet';l2.href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css';document.head.appendChild(l2);
    var s2=document.createElement('script');s2.src='https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js';s2.onload=initMap;document.head.appendChild(s2);
  };
  document.head.appendChild(s);
})();

/* =====================================================
   OSRM route fetcher ‚Äî follows real roads
===================================================== */
function getRoute(waypoints, cb){
  // waypoints: [[lat,lng], [lat,lng], ...]
  var coords=waypoints.map(function(p){return p[1]+','+p[0];}).join(';');
  var url='https://router.project-osrm.org/route/v1/driving/'+coords+'?overview=full&geometries=geojson';
  fetch(url)
    .then(function(r){return r.json();})
    .then(function(data){
      if(data.routes&&data.routes[0]){
        var coords=data.routes[0].geometry.coordinates;
        // OSRM returns [lng,lat], convert to [lat,lng] for Leaflet
        var latlngs=coords.map(function(c){return[c[1],c[0]];});
        cb(latlngs, data.routes[0].distance, data.routes[0].duration);
      }
    })
    .catch(function(){
      // If OSRM unavailable, use waypoints directly as fallback
      cb(waypoints, 0, 0);
    });
}

/* =====================================================
   ROUTE DEFINITIONS
   Using key bus stops / waypoints in Singapore
===================================================== */
var ROUTES={
  '65':{
    color:'#dc2626',
    label:'Bus 65 ‚Äî Tampines to Bedok (via ECP)',
    // Tampines Int ‚Üí Bedok Int via ECP
    waypoints:[[1.3521,103.9401],[1.3350,103.9250],[1.3181,103.9060],[1.3081,103.8730],[1.3081,103.8518]],
    // Alternate: avoid ECP, go inland via Bedok North
    altWaypoints:[[1.3521,103.9401],[1.3480,103.9200],[1.3420,103.9050],[1.3340,103.8950],[1.3220,103.8820],[1.3081,103.8518]],
    incident:{lat:1.3081,lng:103.8680,type:'accident',emoji:'üö®',desc:'3-vehicle collision<br>Bus 65 delayed 18 min'},
    delayMin:18, pax:1240, busCount:8,
    altLabel:'Via Bedok North Rd (avoids ECP)',
    kmOriginal:14.2, kmAlt:11.8
  },
  '131':{
    color:'#9333ea',
    label:'Bus 131 ‚Äî Toa Payoh to Yishun (via CTE)',
    // Toa Payoh ‚Üí Yishun via CTE
    waypoints:[[1.3320,103.8480],[1.3480,103.8380],[1.3620,103.8260],[1.3780,103.8200],[1.4296,103.8353]],
    // Alt: Upper Thomson Rd
    altWaypoints:[[1.3320,103.8480],[1.3420,103.8350],[1.3540,103.8190],[1.3700,103.8100],[1.3900,103.8200],[1.4296,103.8353]],
    incident:{lat:1.3620,lng:103.8260,type:'traffic',emoji:'üî¥',desc:'CTE congestion 6km<br>Bus 131 delayed 22 min'},
    delayMin:22, pax:980, busCount:7,
    altLabel:'Via Upper Thomson Rd (avoids CTE)',
    kmOriginal:16.8, kmAlt:18.1
  },
  '900':{
    color:'#0891b2',
    label:'Bus 900 ‚Äî Woodlands to City Hall',
    // Woodlands ‚Üí City Hall
    waypoints:[[1.4382,103.7890],[1.4200,103.7960],[1.4044,103.7996],[1.3800,103.7850],[1.3500,103.8000],[1.2897,103.8516]],
    // Alt: Avoid Woodlands Ave 12, go via Admiralty
    altWaypoints:[[1.4382,103.7890],[1.4480,103.8050],[1.4350,103.8200],[1.4100,103.8300],[1.3800,103.8200],[1.3500,103.8200],[1.2897,103.8516]],
    incident:{lat:1.4044,lng:103.7996,type:'weather',emoji:'‚õàÔ∏è',desc:'Flash flooding<br>Bus 900 delayed 25 min'},
    delayMin:25, pax:1450, busCount:10,
    altLabel:'Via Admiralty Rd (avoids flood zone)',
    kmOriginal:19.4, kmAlt:21.2
  }
};

/* =====================================================
   MAP INIT
===================================================== */
var map, lgIncidents, lgBuses, lgRoutes, lgCuopt;
var layerStates={incidents:true,buses:true,routes:true};
var routePolylines={};      // original routes
var cuoptPolylines={};      // cuopt dashed routes
var busAnimators={};        // per-route bus animators
var busMarkers={};          // live bus markers per route
var selectedRoute=null;
var routesLoaded={};

function initMap(){
  map=L.map('map',{zoomControl:true,scrollWheelZoom:true}).setView([1.3521,103.8198],12);
  window._map=map;

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'¬© <a href="https://openstreetmap.org/copyright">OpenStreetMap</a> contributors | LTA DataMall | OneMap SLA',
    maxZoom:19,subdomains:['a','b','c']
  }).addTo(map);

  lgIncidents=L.layerGroup().addTo(map);
  lgBuses=L.layerGroup().addTo(map);
  lgRoutes=L.layerGroup().addTo(map);
  lgCuopt=L.layerGroup().addTo(map);

  // Draw all affected routes
  Object.keys(ROUTES).forEach(function(k){loadRoute(k);});

  // Add incident markers
  Object.keys(ROUTES).forEach(function(k){
    var r=ROUTES[k];
    var inc=r.incident;
    var color=inc.type==='accident'?'#dc2626':inc.type==='traffic'?'#9333ea':'#0ea5e9';
    L.circle([inc.lat,inc.lng],{radius:300,color:color,fillColor:color,fillOpacity:.15,weight:2})
     .bindPopup(mkPop(inc.emoji+' Disruption ‚Äî Bus '+k,inc.desc))
     .addTo(lgIncidents);
    L.marker([inc.lat,inc.lng],{icon:eIcon(inc.emoji)})
     .bindPopup(mkPop(inc.emoji+' Disruption ‚Äî Bus '+k,inc.desc))
     .addTo(lgIncidents);
  });

  // Periodic alerts
  setTimeout(function(){showToast('Network Alert','Bus 900 delay now +25 min. cuOPT re-route ready.','var(--warning)');},3000);
  setTimeout(function(){showToast('ECP Update','Accident partially cleared. Still 1 lane blocked.','var(--accent)');},25000);
}

function loadRoute(k){
  var r=ROUTES[k];
  // Fetch real road route from OSRM
  getRoute(r.waypoints,function(latlngs,distM,durS){
    routesLoaded[k]={latlngs:latlngs,distM:distM,durS:durS};
    // Draw original route (red/coloured)
    var pl=L.polyline(latlngs,{color:r.color,weight:5,opacity:.85,smoothFactor:1})
      .bindPopup(mkPop('üöå '+r.label,'<span style="color:'+r.color+'">‚ö† DISRUPTED</span> ¬∑ '+r.busCount+' buses on route<br>Current delay: <b style="color:#dc2626">+'+r.delayMin+' min</b><br><br>Click ‚ö° Request cuOPT Re-route to optimise'))
      .addTo(lgRoutes);
    routePolylines[k]=pl;

    // Spawn buses on this route
    spawnBuses(k, latlngs);

    document.getElementById('map-status').textContent='3 affected routes loaded ‚Äî request re-route to optimise';
  });
}

function eIcon(emoji,size){
  size=size||28;
  return L.divIcon({html:'<div style="font-size:'+size+'px;line-height:1;filter:drop-shadow(0 1px 3px rgba(0,0,0,.3))">'+emoji+'</div>',iconSize:[size,size],iconAnchor:[size/2,size/2],className:''});
}
function mkPop(title,body){
  return '<div style="font-family:\'DM Sans\',sans-serif;min-width:170px"><b style="font-size:13px">'+title+'</b><div style="font-size:11px;color:#555;margin-top:5px;line-height:1.6">'+body+'</div></div>';
}

/* =====================================================
   BUS ANIMATION along road path
===================================================== */
function spawnBuses(routeKey, latlngs){
  if(!latlngs||latlngs.length<2) return;
  var r=ROUTES[routeKey];
  busMarkers[routeKey]=[];
  busAnimators[routeKey]=[];

  // Place N buses evenly spread along the route
  var numBuses=r.busCount;
  for(var i=0;i<numBuses;i++){
    var startFrac=(i/numBuses)%(1);
    var startIdx=Math.floor(startFrac*latlngs.length);
    var m=L.marker(latlngs[startIdx],{icon:eIcon('üöå',18),zIndexOffset:100})
      .bindPopup(mkPop('üöå Bus '+routeKey,'Route: '+r.label+'<br>Status: <span style="color:#dc2626">‚ö† Delayed +'+r.delayMin+' min</span>'))
      .addTo(lgBuses);
    busMarkers[routeKey].push(m);
    animateBus(routeKey, m, latlngs, startIdx);
  }
}

function animateBus(routeKey, marker, path, startIdx){
  var idx=startIdx||0;
  var speed=0.004; // fraction of path per second (slower = more realistic)
  var frac=startIdx/path.length;
  var lastTime=null;

  function step(ts){
    if(!lastTime) lastTime=ts;
    var dt=(ts-lastTime)/1000;
    lastTime=ts;
    frac+=speed*dt;
    if(frac>=1) frac=0;
    var i=Math.floor(frac*path.length);
    if(i>=path.length) i=path.length-1;
    if(marker._map){ // only update if on map
      marker.setLatLng(path[i]);
    }
    var anim=requestAnimationFrame(step);
    // Store raf id so we can cancel
    marker._rafId=anim;
  }
  var rafId=requestAnimationFrame(step);
  marker._rafId=rafId;
}

function swapBusPath(routeKey, newPath){
  // Smoothly migrate buses to the new cuopt path
  if(!busMarkers[routeKey]) return;
  busMarkers[routeKey].forEach(function(m){
    if(m._rafId) cancelAnimationFrame(m._rafId);
    // Random start position on new path
    var startFrac=Math.random();
    animateBus(routeKey, m, newPath, Math.floor(startFrac*newPath.length));
    // Update popup
    m.setPopupContent(mkPop('üöå Bus '+routeKey,'Route: <b style="color:#76b900">cuOPT Re-route Active</b><br>New route: ON TIME ‚úÖ'));
  });
}

/* =====================================================
   LAYER TOGGLE
===================================================== */
window.toggleLayer=function(name,btn){
  layerStates[name]=!layerStates[name];
  var lg={incidents:lgIncidents,buses:lgBuses,routes:lgRoutes}[name];
  layerStates[name]?lg.addTo(map):lg.remove();
  btn.classList.toggle('active',layerStates[name]);
};

/* =====================================================
   SELECT INCIDENT
===================================================== */
window.selectIncident=function(routeKey, el){
  document.querySelectorAll('.inc-card').forEach(function(c){c.classList.remove('sel');});
  el.classList.add('sel');
  selectedRoute=routeKey;
  var r=ROUTES[routeKey];
  var inc=r.incident;
  map.flyTo([inc.lat,inc.lng],14,{duration:1.2});
};

/* =====================================================
   REQUEST REROUTE
===================================================== */
window.requestReroute=function(routeKey){
  if(rerouteDone[routeKey]) return;

  // Select the card
  var card=document.getElementById('card-'+routeKey);
  if(card){
    document.querySelectorAll('.inc-card').forEach(function(c){c.classList.remove('sel');});
    card.classList.add('sel');
  }

  // Fly to incident
  var r=ROUTES[routeKey];
  var inc=r.incident;
  map.flyTo([inc.lat,inc.lng],13,{duration:1});

  // Show computing overlay
  var ov=document.getElementById('computeOv');
  var st=document.getElementById('computeSt');
  var bar=document.getElementById('progBar');
  bar.style.width='0%';
  ov.classList.add('show');

  var steps=[
    'Loading LTA DataMall live feed...',
    'Fetching OneMap road network data...',
    'Applying incident exclusion zones...',
    'Building travel-time cost matrix...',
    'GPU parallel VRP solving on A100...',
    'Evaluating '+Math.floor(Math.random()*8000+5000).toLocaleString()+' route permutations...',
    'Applying fleet & headway constraints...',
    '‚úÖ Optimal re-route found!'
  ];
  var i=0;
  var iv=setInterval(function(){
    if(i<steps.length){
      st.textContent=steps[i];
      bar.style.width=Math.round((i+1)/steps.length*100)+'%';
      i++;
    } else {
      clearInterval(iv);
      var solveMs=Math.floor(Math.random()*400+350);
      document.getElementById('solveTime').textContent=(solveMs/1000).toFixed(2)+'s';

      // Fetch alt route from OSRM
      getRoute(r.altWaypoints,function(altPath,distM,durS){
        ov.classList.remove('show');

        // Remove old polyline
        if(routePolylines[routeKey]){
          lgRoutes.removeLayer(routePolylines[routeKey]);
        }

        // Draw original route faded
        if(routesLoaded[routeKey]){
          L.polyline(routesLoaded[routeKey].latlngs,{color:r.color,weight:3,opacity:.25,dashArray:'4,4'})
           .bindPopup(mkPop('Original Route ‚Äî Bus '+routeKey,'‚ö† DISRUPTED ‚Äî now re-routed by cuOPT'))
           .addTo(lgRoutes);
        }

        // Draw cuOPT re-route in dashed green
        var cuoptPl=L.polyline(altPath,{color:'#76b900',weight:5,opacity:.95,dashArray:'12,8',smoothFactor:1})
          .bindPopup(mkPop('‚ö° cuOPT Re-route ‚Äî Bus '+routeKey,r.altLabel+'<br><b style="color:#4a7c00">GPU-optimised ‚Äî saves '+SAVINGS[routeKey].totalPerTrip.toLocaleString()+' S$/trip</b>'))
          .addTo(lgCuopt);
        cuoptPolylines[routeKey]=cuoptPl;

        // Fit map to show both routes
        var bounds=cuoptPl.getBounds();
        if(routesLoaded[routeKey]&&routesLoaded[routeKey].latlngs.length>0){
          bounds.extend(L.polyline(routesLoaded[routeKey].latlngs).getBounds());
        }
        map.fitBounds(bounds.pad(0.15),{duration:1.2});

        // Migrate buses to new path
        swapBusPath(routeKey, altPath);

        // Show savings modal after brief pause
        setTimeout(function(){showSavingsModal(routeKey);},500);

        document.getElementById('map-status').textContent='Bus '+routeKey+' cuOPT re-route shown in green dashes';
        showToast('cuOPT Route Ready','Bus '+routeKey+' ‚Äî review savings & deploy.','#76b900');
      });
    }
  },280);
};

</script>
</body>
</html>
